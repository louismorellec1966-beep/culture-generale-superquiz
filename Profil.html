<!DOCTYPE html>
<html lang="fr">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-G3YEKJLDRT"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-G3YEKJLDRT');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SuperQuiz - Mon Profil</title>
    <link rel="stylesheet" href="css/style.css">
    
    <!-- Firebase SDK -->
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script defer src="firebase-config.js"></script>
    <script defer src="js/menu.js"></script>
    <script defer src="js/profile-system.js"></script>
    <script defer src="js/streaks-system.js"></script>
    <script defer src="js/titles-system.js"></script>
    <script defer src="js/seasons-system.js"></script>
    <script defer src="js/themes-system.js"></script>
    
    <style>
        .profile-container {
            max-width: 1000px;
            margin: 20px auto;
            padding: 0 20px;
        }

        /* En-t√™te du profil */
        .profile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border-radius: 15px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .profile-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            pointer-events: none;
        }

        .profile-main-info {
            display: flex;
            align-items: center;
            gap: 30px;
            position: relative;
            z-index: 1;
        }

        .avatar-container {
            position: relative;
            cursor: pointer;
        }

        .avatar-large {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            transition: transform 0.3s;
        }

        .avatar-container:hover .avatar-large {
            transform: scale(1.05);
        }

        .avatar-edit-icon {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: #3498db;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .profile-name .edit-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .profile-name .edit-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .profile-bio {
            opacity: 0.9;
            font-style: italic;
            margin-bottom: 15px;
        }

        .level-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
        }

        .level-number {
            background: white;
            color: #667eea;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        /* Barre de progression XP */
        .xp-section {
            margin-top: 20px;
            position: relative;
            z-index: 1;
        }

        .xp-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .xp-bar-container {
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            height: 15px;
            overflow: hidden;
        }

        .xp-bar {
            background: linear-gradient(90deg, #ffd700, #ffed4e);
            height: 100%;
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        /* Cartes de statistiques */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .stat-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        /* Section des badges */
        .section-title {
            font-size: 1.5em;
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .badges-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }

        .badges-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .badge-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .badge-card.earned {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border-color: #28a745;
        }

        .badge-card.locked {
            opacity: 0.5;
            filter: grayscale(1);
        }

        .badge-icon {
            font-size: 2.5em;
            margin-bottom: 8px;
        }

        .badge-name {
            font-weight: bold;
            color: #2c3e50;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .badge-description {
            font-size: 0.75em;
            color: #7f8c8d;
        }

        /* Stats par mati√®re */
        .matiere-stats {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }

        .matiere-row {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .matiere-row:last-child {
            border-bottom: none;
        }

        .matiere-icon {
            font-size: 1.5em;
            width: 50px;
        }

        .matiere-info {
            flex: 1;
        }

        .matiere-name {
            font-weight: bold;
            color: #2c3e50;
        }

        .matiere-detail {
            font-size: 0.85em;
            color: #7f8c8d;
        }

        .matiere-progress {
            width: 150px;
        }

        .progress-bar-mini {
            background: #ecf0f1;
            border-radius: 5px;
            height: 8px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.3s;
        }

        .progress-fill.good { background: #2ecc71; }
        .progress-fill.medium { background: #f39c12; }
        .progress-fill.poor { background: #e74c3c; }

        /* Pr√©f√©rences */
        .preferences-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }

        .preference-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #ecf0f1;
        }

        .preference-row:last-child {
            border-bottom: none;
        }

        .preference-label {
            font-weight: 500;
            color: #2c3e50;
        }

        .preference-control select,
        .preference-control input[type="checkbox"] {
            padding: 8px 15px;
            border: 2px solid #ecf0f1;
            border-radius: 5px;
            font-size: 1em;
        }

        /* Toggle switch */
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #2ecc71;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* Modal Avatar */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            margin: 0;
            color: #2c3e50;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #7f8c8d;
        }

        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .avatar-option {
            aspect-ratio: 1;
            border: 3px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            font-size: 2em;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            transition: all 0.3s;
        }

        .avatar-option:hover {
            border-color: #3498db;
            transform: scale(1.05);
        }

        .avatar-option.selected {
            border-color: #2ecc71;
            background: #d4edda;
        }

        /* Streak display */
        .streak-display {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: linear-gradient(135deg, #ff6b6b, #ffa502);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-weight: bold;
            margin-left: 10px;
        }

        /* Section Streak & Saison */
        .gamification-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .gamification-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .gamification-card:hover {
            transform: translateY(-3px);
        }

        .gamification-card h3 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .streak-big {
            text-align: center;
            padding: 20px;
        }

        .streak-flame {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .streak-count {
            font-size: 2.5em;
            font-weight: bold;
            color: #e74c3c;
        }

        .streak-count span {
            font-size: 0.5em;
            color: #7f8c8d;
            font-weight: normal;
        }

        .streak-rewards {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .streak-milestone {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
        }

        .streak-milestone.achieved {
            background: #d4edda;
            color: #155724;
        }

        .streak-milestone.next {
            background: #fff3cd;
            color: #856404;
        }

        /* Season Card */
        .season-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .season-emoji {
            font-size: 2.5em;
        }

        .season-info h4 {
            margin: 0;
            color: #2c3e50;
        }

        .season-info p {
            margin: 5px 0 0;
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .season-rank {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
        }

        .rank-position {
            font-size: 1.5em;
            font-weight: bold;
        }

        .rank-points {
            font-size: 1.2em;
        }

        /* Titles Section */
        .titles-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }

        .active-title {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            padding: 15px 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .active-title-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .active-title-info span:first-child {
            font-size: 1.5em;
        }

        .titles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .title-card {
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .title-card.unlocked {
            background: #f8f9fa;
        }

        .title-card.unlocked:hover {
            border-color: #3498db;
            transform: translateY(-2px);
        }

        .title-card.locked {
            background: #f8f9fa;
            opacity: 0.5;
            filter: grayscale(0.8);
        }

        .title-card.active {
            border-color: #ffd700;
            background: #fff9e6;
        }

        .title-emoji {
            font-size: 1.8em;
            margin-bottom: 8px;
        }

        .title-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .title-rarity {
            font-size: 0.75em;
            padding: 3px 8px;
            border-radius: 10px;
            display: inline-block;
        }

        .title-rarity.common { background: #ecf0f1; color: #7f8c8d; }
        .title-rarity.rare { background: #d4edda; color: #155724; }
        .title-rarity.epic { background: #e2d5f7; color: #6f42c1; }
        .title-rarity.legendary { background: #fff3cd; color: #856404; }
        .title-rarity.mythic { background: linear-gradient(135deg, #ff6b6b, #ffd700); color: white; }

        /* Loading */
        .loading-container {
            text-align: center;
            padding: 100px 20px;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Non connect√© */
        .not-connected {
            text-align: center;
            padding: 80px 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }

        .not-connected h2 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .btn-primary {
            display: inline-block;
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            text-decoration: none;
            border-radius: 10px;
            font-weight: bold;
            transition: transform 0.3s;
            border: none;
            cursor: pointer;
            font-size: 1em;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
        }

        /* Modal √©dition profil */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 1em;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .profile-main-info {
                flex-direction: column;
                text-align: center;
            }

            .avatar-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .matiere-row {
                flex-wrap: wrap;
            }

            .matiere-progress {
                width: 100%;
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <main>
        <div class="profile-container">
            <div id="content-container">
                <div class="loading-container">
                    <div class="loading-spinner"></div>
                    <p>Chargement du profil...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Avatar -->
    <div id="avatar-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üé® Choisir un avatar</h2>
                <button class="modal-close" onclick="closeAvatarModal()">√ó</button>
            </div>
            <div class="avatar-grid" id="avatar-grid"></div>
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn-primary" onclick="saveAvatar()">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- Modal √âdition Profil -->
    <div id="edit-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚úèÔ∏è Modifier le profil</h2>
                <button class="modal-close" onclick="closeEditModal()">√ó</button>
            </div>
            <form id="edit-form" onsubmit="saveProfile(event)">
                <div class="form-group">
                    <label for="edit-pseudo">Pseudo</label>
                    <input type="text" id="edit-pseudo" maxlength="30" required>
                </div>
                <div class="form-group">
                    <label for="edit-bio">Bio</label>
                    <textarea id="edit-bio" rows="3" maxlength="200" placeholder="Parlez-nous de vous..."></textarea>
                </div>
                <div style="text-align: center;">
                    <button type="submit" class="btn-primary">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <footer>
        <p>Copyright ¬© 2024 SuperQuiz. Tous droits r√©serv√©s.</p>
    </footer>

    <script src="js/script.js"></script>
    <script>
        let currentUser = null;
        let currentProfile = null;
        let selectedAvatar = null;

        // Attendre le chargement de Firebase
        window.addEventListener('load', () => {
            setTimeout(initProfile, 100);
        });

        function initProfile() {
            if (typeof firebase === 'undefined' || !firebase.auth) {
                setTimeout(initProfile, 200);
                return;
            }

            firebase.auth().onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    await loadProfile(user.uid);
                } else {
                    showNotConnected();
                }
            });
        }

        async function loadProfile(userId) {
            try {
                let profile = await ProfileSystem.getProfile(userId);
                
                // Cr√©er le profil s'il n'existe pas
                if (!profile) {
                    const userData = { name: currentUser.name, email: currentUser.email };
                    await ProfileSystem.createProfile(userId, userData);
                    profile = await ProfileSystem.getProfile(userId);
                }
                
                currentProfile = profile;
                displayProfile(profile);
            } catch (error) {
                console.error('Erreur chargement profil:', error);
                document.getElementById('content-container').innerHTML = `
                    <div class="not-connected">
                        <h2>‚ùå Erreur</h2>
                        <p>Impossible de charger le profil: ${error.message}</p>
                        <button class="btn-primary" onclick="location.reload()">R√©essayer</button>
                    </div>
                `;
            }
        }

        function displayProfile(profile) {
            const container = document.getElementById('content-container');
            const stats = profile.stats || {};
            const niveau = profile.niveau || 1;
            const xp = profile.experiencePoints || 0;
            const xpProgress = XPSystem.progressionNiveau(xp);
            const xpPourProchain = XPSystem.xpPourProchainNiveau(niveau);
            
        
            // Avatar
            const avatarDisplay = profile.avatar?.value || 'üë§';
            
            // Statistiques par mati√®re
            const matieres = stats.matieres || {};
            const matiereIcons = {
                histoire: 'üìú',
                geographie: 'üó∫Ô∏è',
                science: 'üî¨',
                litterature: 'üìö',
                art: 'üé®',
                musique: 'üéµ',
                cinema: 'üé¨',
                sport: '‚öΩ',
                gastronomie: 'üçΩÔ∏è',
                philosophie: 'ü§î',
                politique: 'üèõÔ∏è',
                culture: 'üåç'
            };
            const matiereNames = {
                histoire: 'Histoire',
                geographie: 'G√©ographie',
                science: 'Science',
                litterature: 'Litt√©rature',
                art: 'Art',
                musique: 'Musique',
                cinema: 'Cin√©ma',
                sport: 'Sport',
                gastronomie: 'Gastronomie',
                philosophie: 'Philosophie',
                politique: 'Politique',
                culture: 'Culture G√©n√©rale'
            };

            let matieresHTML = '';
            for (const [key, name] of Object.entries(matiereNames)) {
                const data = matieres[key] || { quizCount: 0, tauxReussite: 0 };
                if (data.quizCount > 0) {
                    const progressClass = data.tauxReussite >= 80 ? 'good' : data.tauxReussite >= 50 ? 'medium' : 'poor';
                    matieresHTML += `
                        <div class="matiere-row">
                            <div class="matiere-icon">${matiereIcons[key] || 'üìò'}</div>
                            <div class="matiere-info">
                                <div class="matiere-name">${name}</div>
                                <div class="matiere-detail">${data.quizCount} quiz ‚Ä¢ ${data.tauxReussite || 0}% de r√©ussite</div>
                            </div>
                            <div class="matiere-progress">
                                <div class="progress-bar-mini">
                                    <div class="progress-fill ${progressClass}" style="width: ${data.tauxReussite || 0}%"></div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            // Badges
            const allBadges = Object.entries(BADGES);
            const earnedBadges = profile.badges || [];
            
            let badgesHTML = allBadges.map(([id, badge]) => {
                const earned = earnedBadges.includes(id);
                return `
                    <div class="badge-card ${earned ? 'earned' : 'locked'}" title="${badge.description}">
                        <div class="badge-icon">${badge.icone}</div>
                        <div class="badge-name">${badge.nom}</div>
                        <div class="badge-description">${badge.description}</div>
                    </div>
                `;
            }).join('');

            // Titre actif
            const activeTitle = profile.activeTitle;

            container.innerHTML = `
                <!-- En-t√™te du profil -->
                <div class="profile-header">
                    <div class="profile-main-info">
                        <div class="avatar-container" onclick="openAvatarModal()">
                            <div class="avatar-large">${avatarDisplay}</div>
                            <div class="avatar-edit-icon">‚úèÔ∏è</div>
                        </div>
                        <div class="profile-info">
                            <div class="profile-name">
                                ${profile.pseudo || 'Joueur'}
                                ${stats.streakActuelle > 0 ? `<span class="streak-display">üî• ${stats.streakActuelle} jours</span>` : ''}
                                <button class="edit-btn" onclick="openEditModal()">‚úèÔ∏è Modifier</button>
                            </div>
                            <div class="profile-bio">${profile.bio || 'Aucune bio d√©finie'}</div>
                            <div class="level-badge">
                                <span class="level-number">${niveau}</span>
                                <span>Niveau ${niveau}</span>
                            </div>
                        </div>
                    </div>
                    <div class="xp-section">
                        <div class="xp-info">
                            <span>${xp} XP</span>
                            <span>${xpPourProchain} XP pour niveau ${niveau + 1}</span>
                        </div>
                        <div class="xp-bar-container">
                            <div class="xp-bar" style="width: ${xpProgress}%"></div>
                        </div>
                    </div>
                </div>

                <!-- Streak & Saison -->
                <div class="gamification-grid">
                    <div class="gamification-card" id="streak-card">
                        <h3>üî• S√©rie quotidienne</h3>
                        <div class="streak-big">
                            <div class="streak-flame" id="streak-flame">üî•</div>
                            <div class="streak-count" id="streak-count">0 <span>jours</span></div>
                            <div class="streak-rewards" id="streak-rewards"></div>
                        </div>
                    </div>
                    <div class="gamification-card" id="season-card">
                        <h3>üèÜ Saison comp√©titive</h3>
                        <div id="season-content">
                            <p style="text-align: center; color: #7f8c8d;">Chargement...</p>
                        </div>
                    </div>
                </div>

                <!-- Titres -->
                <div class="titles-section" id="titles-section">
                    <h2 class="section-title">üëë Titres</h2>
                    <div id="active-title-container"></div>
                    <div class="titles-grid" id="titles-grid">
                        <p style="text-align: center; color: #7f8c8d;">Chargement des titres...</p>
                    </div>
                </div>

                <!-- Statistiques principales -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üéØ</div>
                        <div class="stat-value">${stats.totalQuiz || 0}</div>
                        <div class="stat-label">Quiz compl√©t√©s</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-value">${stats.totalBonnesReponses || 0}</div>
                        <div class="stat-label">Bonnes r√©ponses</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üìä</div>
                        <div class="stat-value">${stats.tauxReussite || 0}%</div>
                        <div class="stat-label">Taux de r√©ussite</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üíØ</div>
                        <div class="stat-value">${stats.quizParfaits || 0}</div>
                        <div class="stat-label">Quiz parfaits</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üèÜ</div>
                        <div class="stat-value">${earnedBadges.length}</div>
                        <div class="stat-label">Badges obtenus</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚è±Ô∏è</div>
                        <div class="stat-value">${formatTime(stats.tempsJeuTotal || 0)}</div>
                        <div class="stat-label">Temps de jeu</div>
                    </div>
                </div>

                <!-- Stats par mati√®re -->
                <div class="matiere-stats">
                    <h2 class="section-title">üìö Statistiques par mati√®re</h2>
                    ${matieresHTML || '<p style="color: #7f8c8d; text-align: center;">Aucune donn√©e disponible. Commencez √† jouer !</p>'}
                </div>

                <!-- Badges -->
                <div class="badges-section">
                    <h2 class="section-title">üèÖ Badges (${earnedBadges.length}/${allBadges.length})</h2>
                    <div class="badges-grid">
                        ${badgesHTML}
                    </div>
                </div>

                <!-- Pr√©f√©rences -->
                <div class="preferences-section">
                    <h2 class="section-title">‚öôÔ∏è Pr√©f√©rences</h2>
                    <p style="margin-bottom: 15px;">
                        <a href="parametres.html" style="color: #3498db; text-decoration: none;">
                            Acc√©der aux param√®tres avanc√©s (th√®mes, notifications...) ‚Üí
                        </a>
                    </p>
                    <div class="preference-row">
                        <span class="preference-label">üìä Difficult√© pr√©f√©r√©e</span>
                        <div class="preference-control">
                            <select id="pref-difficulte" onchange="updatePreference('difficulte', this.value)">
                                <option value="facile" ${profile.preferences?.difficulte === 'facile' ? 'selected' : ''}>Facile</option>
                                <option value="moyen" ${profile.preferences?.difficulte === 'moyen' ? 'selected' : ''}>Moyen</option>
                                <option value="difficile" ${profile.preferences?.difficulte === 'difficile' ? 'selected' : ''}>Difficile</option>
                            </select>
                        </div>
                    </div>
                    <div class="preference-row">
                        <span class="preference-label">üëÅÔ∏è Profil visible publiquement</span>
                        <div class="preference-control">
                            <label class="toggle-switch">
                                <input type="checkbox" id="pref-visible" 
                                    ${profile.preferences?.afficherProfil !== false ? 'checked' : ''}
                                    onchange="updatePreference('afficherProfil', this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            `;

            // Initialiser la grille d'avatars
            initAvatarGrid();
            
            // Charger les donn√©es de gamification
            loadGamificationData();
        }

        // Charger les donn√©es de streak, saison et titres
        async function loadGamificationData() {
            if (!currentUser) return;

            // Charger le streak
            if (typeof StreaksSystem !== 'undefined') {
                try {
                    const streakInfo = await StreaksSystem.getStreakInfo(currentUser.uid);
                    const flameLevel = StreaksSystem.getFlameLevel(streakInfo?.currentStreak || 0);
                    
                    document.getElementById('streak-flame').textContent = flameLevel;
                    document.getElementById('streak-count').innerHTML = `${streakInfo?.currentStreak || 0} <span>jours</span>`;
                    
                    // Afficher les prochaines r√©compenses
                    const milestones = [3, 7, 14, 30];
                    const currentStreak = streakInfo?.currentStreak || 0;
                    let rewardsHTML = '';
                    
                    milestones.forEach(m => {
                        if (currentStreak >= m) {
                            rewardsHTML += `<span class="streak-milestone achieved">‚úì ${m}j</span>`;
                        } else if (currentStreak < m && !rewardsHTML.includes('next')) {
                            rewardsHTML += `<span class="streak-milestone next">‚Üí ${m}j</span>`;
                        }
                    });
                    
                    document.getElementById('streak-rewards').innerHTML = rewardsHTML;
                } catch (e) {
                    console.error('Erreur chargement streak:', e);
                }
            }

            // Charger la saison
            if (typeof SeasonsSystem !== 'undefined') {
                try {
                    const season = SeasonsSystem.getCurrentSeason();
                    const userRank = await SeasonsSystem.getUserSeasonRank(currentUser.uid);
                    
                    document.getElementById('season-content').innerHTML = `
                        <div class="season-header">
                            <div class="season-emoji">${season.emoji}</div>
                            <div class="season-info">
                                <h4>Saison ${season.name}</h4>
                                <p>${season.description}</p>
                            </div>
                        </div>
                        <div class="season-rank">
                            <div>
                                <small>Classement</small>
                                <div class="rank-position">#${userRank?.position || '-'}</div>
                            </div>
                            <div style="text-align: right;">
                                <small>Points saison</small>
                                <div class="rank-points">${userRank?.points || 0} pts</div>
                            </div>
                        </div>
                        <p style="text-align: center; margin-top: 15px;">
                            <a href="Classement.html" style="color: #667eea; text-decoration: none;">
                                Voir le classement complet ‚Üí
                            </a>
                        </p>
                    `;
                } catch (e) {
                    console.error('Erreur chargement saison:', e);
                }
            }

            // Charger les titres
            if (typeof TitlesSystem !== 'undefined') {
                try {
                    const unlockedTitles = await TitlesSystem.checkUnlockedTitles(currentUser.uid);
                    const allTitles = TitlesSystem.TITLES;
                    const activeTitle = currentProfile?.activeTitle;
                    
                    // Titre actif
                    let activeTitleHTML = '';
                    if (activeTitle && allTitles[activeTitle]) {
                        const title = allTitles[activeTitle];
                        activeTitleHTML = `
                            <div class="active-title">
                                <div class="active-title-info">
                                    <span>${title.emoji}</span>
                                    <strong>${title.name}</strong>
                                </div>
                                <span style="color: #856404;">Titre actif</span>
                            </div>
                        `;
                    } else {
                        activeTitleHTML = `
                            <div class="active-title" style="background: #f8f9fa;">
                                <div class="active-title-info">
                                    <span>üë§</span>
                                    <span style="color: #7f8c8d;">Aucun titre s√©lectionn√©</span>
                                </div>
                            </div>
                        `;
                    }
                    document.getElementById('active-title-container').innerHTML = activeTitleHTML;
                    
                    // Grille des titres
                    const titlesHTML = Object.entries(allTitles).map(([id, title]) => {
                        const isUnlocked = unlockedTitles.includes(id);
                        const isActive = activeTitle === id;
                        
                        return `
                            <div class="title-card ${isUnlocked ? 'unlocked' : 'locked'} ${isActive ? 'active' : ''}"
                                 onclick="${isUnlocked ? `setActiveTitle('${id}')` : ''}"
                                 title="${title.description}">
                                <div class="title-emoji">${title.emoji}</div>
                                <div class="title-name">${title.name}</div>
                                <span class="title-rarity ${title.rarity}">${title.rarity}</span>
                            </div>
                        `;
                    }).join('');
                    
                    document.getElementById('titles-grid').innerHTML = titlesHTML || '<p style="text-align: center; color: #7f8c8d;">Aucun titre disponible</p>';
                } catch (e) {
                    console.error('Erreur chargement titres:', e);
                }
            }
        }

        // D√©finir le titre actif
        async function setActiveTitle(titleId) {
            try {
                await TitlesSystem.setActiveTitle(currentUser.uid, titleId);
                currentProfile.activeTitle = titleId;
                loadGamificationData(); // Recharger l'affichage
            } catch (error) {
                console.error('Erreur changement titre:', error);
                alert('Erreur lors du changement de titre');
            }
        }

        function formatTime(seconds) {
            if (seconds < 60) return `${seconds}s`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)}min`;
            const hours = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            return `${hours}h${mins}m`;
        }

        // Modal Avatar
        function initAvatarGrid() {
            const grid = document.getElementById('avatar-grid');
            grid.innerHTML = AVATARS_PREDEFINIES.map(avatar => `
                <div class="avatar-option ${currentProfile?.avatar?.value === avatar.emoji ? 'selected' : ''}" 
                     onclick="selectAvatar('${avatar.emoji}')" 
                     data-emoji="${avatar.emoji}">
                    ${avatar.emoji}
                </div>
            `).join('');
            selectedAvatar = currentProfile?.avatar?.value || 'üë§';
        }

        function openAvatarModal() {
            document.getElementById('avatar-modal').classList.add('active');
        }

        function closeAvatarModal() {
            document.getElementById('avatar-modal').classList.remove('active');
        }

        function selectAvatar(emoji) {
            selectedAvatar = emoji;
            document.querySelectorAll('.avatar-option').forEach(el => {
                el.classList.toggle('selected', el.dataset.emoji === emoji);
            });
        }

        async function saveAvatar() {
            try {
                await ProfileSystem.updateAvatar(currentUser.uid, {
                    type: 'emoji',
                    value: selectedAvatar
                });
                closeAvatarModal();
                loadProfile(currentUser.uid);
            } catch (error) {
                alert('Erreur lors de la sauvegarde: ' + error.message);
            }
        }

        // Modal √âdition
        function openEditModal() {
            document.getElementById('edit-pseudo').value = currentProfile?.pseudo || '';
            document.getElementById('edit-bio').value = currentProfile?.bio || '';
            document.getElementById('edit-modal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('active');
        }

        async function saveProfile(e) {
            e.preventDefault();
            try {
                await ProfileSystem.updateProfile(currentUser.uid, {
                    pseudo: document.getElementById('edit-pseudo').value.trim(),
                    bio: document.getElementById('edit-bio').value.trim()
                });
                closeEditModal();
                loadProfile(currentUser.uid);
            } catch (error) {
                alert('Erreur lors de la sauvegarde: ' + error.message);
            }
        }

        // Pr√©f√©rences
        async function updatePreference(key, value) {
            try {
                const prefs = { ...currentProfile.preferences, [key]: value };
                await ProfileSystem.updatePreferences(currentUser.uid, prefs);
                currentProfile.preferences = prefs;
            } catch (error) {
                alert('Erreur: ' + error.message);
            }
        }

        function showNotConnected() {
            document.getElementById('content-container').innerHTML = `
                <div class="not-connected">
                    <h2>üîí Acc√®s restreint</h2>
                    <p>Connectez-vous pour acc√©der √† votre profil</p>
                    <a href="Auth.html" class="btn-primary">Se connecter</a>
                </div>
            `;
        }

        // Fermer les modaux en cliquant √† l'ext√©rieur
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>