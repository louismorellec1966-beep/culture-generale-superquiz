<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nettoyage Cache Firebase</title>
</head>
<body>
    <h1>üßπ Nettoyage Cache Firebase</h1>
    <p>Cette page nettoie le cache local et les donn√©es Firebase qui peuvent causer des erreurs QUIC.</p>

    <button onclick="clearFirebaseCache()">Nettoyer le cache Firebase</button>
    <button onclick="clearAllLocalData()">Nettoyer toutes les donn√©es locales</button>
    <div id="results" style="margin-top: 20px; font-family: monospace; white-space: pre-line;"></div>

    <script>
        function clearFirebaseCache() {
            const results = document.getElementById('results');
            results.textContent = 'üßπ Nettoyage du cache Firebase...\n\n';

            try {
                // Supprimer les donn√©es Firebase du localStorage
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.includes('firebase') || key.includes('firestore') || key.includes('auth'))) {
                        keysToRemove.push(key);
                    }
                }

                keysToRemove.forEach(key => {
                    localStorage.removeItem(key);
                    results.textContent += `   üóëÔ∏è Supprim√©: ${key}\n`;
                });

                // Supprimer les donn√©es sp√©cifiques au projet
                const projectKeys = [
                    'seasonData',
                    'seasonStats',
                    'userProfile',
                    'quizProgress',
                    'dailyRewards',
                    'cultureCards',
                    'customQuizzes'
                ];

                projectKeys.forEach(key => {
                    if (localStorage.getItem(key)) {
                        localStorage.removeItem(key);
                        results.textContent += `   üóëÔ∏è Supprim√©: ${key}\n`;
                    }
                });

                // Vider le cache de session
                if ('caches' in window) {
                    caches.keys().then(names => {
                        names.forEach(name => {
                            if (name.includes('firebase') || name.includes('firestore')) {
                                caches.delete(name);
                                results.textContent += `   üóëÔ∏è Cache supprim√©: ${name}\n`;
                            }
                        });
                    });
                }

                // Forcer le rechargement de Firebase
                if (typeof firebase !== 'undefined') {
                    // D√©connecter l'utilisateur
                    firebase.auth().signOut();
                    results.textContent += '   üë§ Utilisateur d√©connect√©\n';
                }

                results.textContent += '\n‚úÖ Cache Firebase nettoy√©\n';
                results.textContent += 'üí° Rechargez la page pour r√©initialiser Firebase\n';

            } catch (error) {
                results.textContent += `\n‚ùå Erreur lors du nettoyage: ${error.message}\n`;
            }
        }

        function clearAllLocalData() {
            const results = document.getElementById('results');
            results.textContent = 'üßπ Nettoyage complet des donn√©es locales...\n\n';

            try {
                const totalItems = localStorage.length;

                // Garder seulement les donn√©es essentielles (si n√©cessaire)
                const essentialKeys = []; // Liste des cl√©s √† garder si besoin

                for (let i = localStorage.length - 1; i >= 0; i--) {
                    const key = localStorage.key(i);
                    if (key && !essentialKeys.includes(key)) {
                        localStorage.removeItem(key);
                        results.textContent += `   üóëÔ∏è Supprim√©: ${key}\n`;
                    }
                }

                // Vider tous les caches
                if ('caches' in window) {
                    caches.keys().then(names => {
                        names.forEach(name => {
                            caches.delete(name);
                            results.textContent += `   üóëÔ∏è Cache supprim√©: ${name}\n`;
                        });
                    });
                }

                // Vider les cookies Firebase
                document.cookie.split(";").forEach(c => {
                    document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
                });

                results.textContent += `\n‚úÖ ${totalItems} √©l√©ments supprim√©s du localStorage\n`;
                results.textContent += '‚úÖ Caches vid√©s\n';
                results.textContent += '‚úÖ Cookies nettoy√©s\n';
                results.textContent += '\nüí° Rechargez compl√®tement la page (Ctrl+F5)\n';

            } catch (error) {
                results.textContent += `\n‚ùå Erreur lors du nettoyage: ${error.message}\n`;
            }
        }
    </script>
</body>
</html>