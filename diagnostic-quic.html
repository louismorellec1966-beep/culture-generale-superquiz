<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic Firebase QUIC</title>
    <!-- Firebase SDK -->
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script defer src="firebase-config.js"></script>
</head>
<body>
    <h1>üîç Diagnostic Firebase QUIC</h1>
    <p>Cette page diagnostique les erreurs QUIC_PROTOCOL_ERROR et QUIC_NETWORK_IDLE_TIMEOUT.</p>

    <button onclick="runDiagnostics()">Lancer le diagnostic</button>
    <div id="results" style="margin-top: 20px; font-family: monospace; white-space: pre-line;"></div>

    <script>
        async function runDiagnostics() {
            const results = document.getElementById('results');
            results.textContent = 'üîÑ D√©marrage du diagnostic...\n\n';

            try {
                // Attendre Firebase
                await new Promise(resolve => setTimeout(resolve, 3000));

                results.textContent += '‚úÖ Firebase charg√©\n';

                // Test de connexion basique
                try {
                    const testDoc = await firebase.firestore().collection('profiles').limit(1).get();
                    results.textContent += '‚úÖ Connexion Firestore basique: OK\n';
                } catch (error) {
                    results.textContent += `‚ùå Connexion Firestore basique: ${error.message}\n`;
                }

                // Test d'authentification
                const user = firebase.auth().currentUser;
                if (user) {
                    results.textContent += `‚úÖ Utilisateur connect√©: ${user.email}\n`;
                } else {
                    results.textContent += '‚ÑπÔ∏è Utilisateur non connect√©\n';
                }

                // Test des listeners (source potentielle des erreurs QUIC)
                results.textContent += '\nüîç Test des listeners Firestore (cause fr√©quente des erreurs QUIC):\n';

                // Test listener simple
                try {
                    const unsubscribe = firebase.firestore()
                        .collection('profiles')
                        .limit(1)
                        .onSnapshot((snapshot) => {
                            results.textContent += '‚úÖ Listener simple: OK\n';
                            unsubscribe(); // Se d√©sabonner imm√©diatement
                        }, (error) => {
                            results.textContent += `‚ùå Listener simple: ${error.message}\n`;
                        });

                    // Attendre un peu pour le r√©sultat
                    await new Promise(resolve => setTimeout(resolve, 2000));

                } catch (error) {
                    results.textContent += `‚ùå Test listener: ${error.message}\n`;
                }

                // V√©rifier les param√®tres Firestore
                results.textContent += '\n‚öôÔ∏è Param√®tres Firestore:\n';
                const settings = firebase.firestore()._settings;
                if (settings) {
                    results.textContent += `   experimentalForceLongPolling: ${settings.experimentalForceLongPolling || false}\n`;
                    results.textContent += `   host: ${settings.host || 'd√©faut'}\n`;
                } else {
                    results.textContent += '   Param√®tres non accessibles\n';
                }

                // Test de r√©seau
                results.textContent += '\nüåê Test de r√©seau:\n';
                try {
                    const response = await fetch('https://firestore.googleapis.com/v1/projects/super-quiz-da40b/databases/(default)/documents:runQuery', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            structuredQuery: {
                                from: [{ collectionId: 'profiles' }],
                                limit: 1
                            }
                        })
                    });

                    if (response.ok) {
                        results.textContent += '‚úÖ API REST Firestore: OK\n';
                    } else {
                        results.textContent += `‚ö†Ô∏è API REST Firestore: ${response.status}\n`;
                    }
                } catch (error) {
                    results.textContent += `‚ùå API REST Firestore: ${error.message}\n`;
                }

                // Recommandations
                results.textContent += '\nüí° RECOMMANDATIONS:\n';

                const hasQuicErrors = results.textContent.includes('QUIC');
                if (hasQuicErrors) {
                    results.textContent += '   ‚ùå Erreurs QUIC d√©tect√©es - La configuration anti-QUIC devrait aider\n';
                    results.textContent += '   üîß Essayez de vider le cache du navigateur\n';
                    results.textContent += '   üîß D√©sactivez temporairement les extensions VPN/proxy\n';
                    results.textContent += '   üîß Utilisez un r√©seau diff√©rent si possible\n';
                } else {
                    results.textContent += '   ‚úÖ Aucune erreur QUIC d√©tect√©e\n';
                }

                results.textContent += '\nüèÅ DIAGNOSTIC TERMIN√â\n';

            } catch (error) {
                results.textContent += `\nüí• ERREUR G√âN√âRALE: ${error.message}\n`;
            }
        }
    </script>
</body>
</html>