<!DOCTYPE html>
<html lang="fr">
<head>
    <link rel="icon" type="image/png" sizes="32x32" href="Images/favicon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="Images/favicon-16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="Images/logo-192.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÆ Mode Survie - SuperQuiz</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="js/script.js" defer></script>
    
    <!-- Firebase SDK -->
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script defer src="firebase-config.js"></script>
    <script src="js/menu.js" defer></script>
    
    <style>
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            padding: 20px;
            padding-top: 80px;
        }

        .survival-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .game-header {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .game-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #e74c3c, #f39c12, #e74c3c);
            background-size: 200% 100%;
            animation: gradientMove 3s linear infinite;
        }

        @keyframes gradientMove {
            0% { background-position: 0% 0%; }
            100% { background-position: 200% 0%; }
        }

        .game-header h1 {
            font-size: 2.5em;
            margin: 0 0 10px 0;
            background: linear-gradient(135deg, #e74c3c, #f39c12);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .game-header > p {
            color: var(--text-secondary, #a0aec0);
        }

        .game-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-box:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(231, 76, 60, 0.3);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            background: linear-gradient(135deg, #e74c3c, #f39c12);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 0.85em;
            color: var(--text-muted, #718096);
            margin-top: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .lives-display {
            font-size: 3em;
            margin: 20px 0;
            text-align: center;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
        }

        .progress-section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .progress-bar-container {
            background: rgba(255, 255, 255, 0.1);
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #e74c3c, #f39c12);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            position: relative;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .next-milestone {
            text-align: center;
            margin-top: 10px;
            font-size: 1em;
            color: var(--text-secondary, #a0aec0);
        }

        .badge-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
            font-size: 1.3em;
            color: white;
        }

        .badge-icon {
            font-size: 2em;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .question-section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            display: none;
            animation: fadeInUp 0.4s ease-out;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .question-section.active {
            display: block;
        }

        .question-number {
            background: linear-gradient(135deg, #e74c3c, #f39c12);
            color: white;
            padding: 8px 18px;
            border-radius: 20px;
            font-size: 0.9em;
            display: inline-block;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .difficulty-badge {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            padding: 5px 14px;
            border-radius: 15px;
            font-size: 0.8em;
            margin-left: 10px;
            font-weight: 500;
        }

        .difficulty-badge.facile {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }

        .difficulty-badge.moyen {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .difficulty-badge.difficile {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .question-text {
            font-size: 1.3em;
            font-weight: bold;
            margin: 20px 0;
            color: white;
            line-height: 1.5;
        }

        .answer-option {
            display: block;
            margin: 12px 0;
            padding: 18px 20px;
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.03);
            font-size: 1.05em;
            color: white;
        }

        .answer-option:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(231, 76, 60, 0.5);
            transform: translateX(8px);
            box-shadow: 0 4px 20px rgba(231, 76, 60, 0.2);
        }

        .answer-option.selected {
            background: rgba(231, 76, 60, 0.15);
            border-color: #e74c3c;
        }

        .answer-option.correct {
            background: rgba(46, 204, 113, 0.2);
            border-color: #2ecc71;
            animation: pulse-correct 0.5s;
        }

        .answer-option.incorrect {
            background: rgba(231, 76, 60, 0.2);
            border-color: #e74c3c;
            animation: shake 0.5s;
        }

        @keyframes pulse-correct {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .validate-btn {
            background: linear-gradient(135deg, #e74c3c, #f39c12);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            display: block;
            width: 100%;
            font-weight: 600;
        }

        .validate-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(231, 76, 60, 0.4);
        }

        .validate-btn:disabled {
            background: rgba(255, 255, 255, 0.1);
            cursor: not-allowed;
            transform: none;
            color: var(--text-muted, #718096);
        }

        .start-screen {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 50px 40px;
            text-align: center;
        }

        .start-screen h2 {
            color: white;
            margin-bottom: 20px;
            font-size: 2rem;
        }

        .rules-list {
            text-align: left;
            max-width: 500px;
            margin: 30px auto;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 16px;
            list-style: none;
        }

        .rules-list li {
            margin: 12px 0;
            font-size: 1em;
            color: var(--text-secondary, #a0aec0);
        }

        .start-btn {
            background: linear-gradient(135deg, #e74c3c, #f39c12);
            color: white;
            border: none;
            padding: 20px 50px;
            border-radius: 50px;
            font-size: 1.4em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(231, 76, 60, 0.4);
            margin-top: 30px;
            position: relative;
            overflow: hidden;
        }

        .start-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .start-btn:hover::before {
            left: 100%;
        }

        .start-btn:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 15px 40px rgba(231, 76, 60, 0.5);
        }

        .game-over-screen {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 50px 40px;
            text-align: center;
            display: none;
        }

        .game-over-screen h2 {
            color: white;
            font-size: 2rem;
        }

        .game-over-screen.active {
            display: block;
            animation: fadeInUp 0.5s ease-out;
        }

        .final-score {
            font-size: 5em;
            font-weight: bold;
            background: linear-gradient(135deg, #e74c3c, #f39c12);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 20px 0;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
        }

        .achievement {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 170, 0, 0.2));
            border: 2px solid #ffd700;
            padding: 20px 30px;
            border-radius: 16px;
            margin: 25px 0;
            font-size: 1.3em;
            font-weight: bold;
            color: #ffd700;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .records-display {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 30px 0;
        }

        .record-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 16px;
            transition: all 0.3s ease;
        }

        .record-card:hover {
            border-color: rgba(231, 76, 60, 0.3);
        }

        .record-title {
            font-size: 0.85em;
            color: var(--text-muted, #718096);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .record-value {
            font-size: 2.2em;
            font-weight: bold;
            background: linear-gradient(135deg, #e74c3c, #f39c12);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-top: 10px;
        }

        .leaderboard {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            padding: 25px;
            border-radius: 16px;
            margin-top: 30px;
            max-height: 300px;
            overflow-y: auto;
        }

        .leaderboard-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 20px;
            color: white;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            margin: 8px 0;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            color: var(--text-secondary, #a0aec0);
            transition: all 0.2s ease;
        }

        .leaderboard-item:hover {
            background: rgba(255, 255, 255, 0.06);
        }

        .leaderboard-item.current-user {
            background: rgba(231, 76, 60, 0.15);
            border: 2px solid #e74c3c;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.1em;
            color: var(--text-muted, #718096);
        }

        @media (max-width: 768px) {
            body {
                padding-top: 20px;
                padding-bottom: 100px;
            }

            .game-header h1 {
                font-size: 1.8em;
            }

            .lives-display {
                font-size: 2em;
            }

            .final-score {
                font-size: 3.5em;
            }

            .records-display {
                grid-template-columns: 1fr;
            }

            .start-screen, .game-over-screen {
                padding: 30px 20px;
            }
        }
    </style>
</head>
<body>
    <div class="survival-container" style="margin-top: 0; padding-top: 20px;">
        <!-- En-t√™te du jeu -->
        <div class="game-header">
            <h1>üéÆ MODE SURVIE</h1>
            <p style="color: #7f8c8d; font-size: 1.1em;">Encha√Æne les questions jusqu'√† 3 erreurs !</p>
            
            <div class="game-stats">
                <div class="stat-box">
                    <div class="stat-value" id="current-score">0</div>
                    <div class="stat-label">Score Actuel</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="personal-record">-</div>
                    <div class="stat-label">Record Personnel</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="world-record">-</div>
                    <div class="stat-label">Record Mondial</div>
                </div>
            </div>
            
            <div class="lives-display" id="lives-display">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
        </div>

        <!-- Progression vers palier -->
        <div class="progress-section" id="progress-section" style="display: none;">
            <div class="badge-display" id="current-badge">
                <span class="badge-icon">ü•â</span>
                <span>D√©butant</span>
            </div>
            
            <div class="progress-bar-container">
                <div class="progress-bar" id="progress-bar" style="width: 0%;">0/10</div>
            </div>
            
            <div class="next-milestone" id="next-milestone">
                Prochain palier : Confirm√© (10 questions) ü•à
            </div>
        </div>

        <!-- √âcran de d√©marrage -->
        <div class="start-screen" id="start-screen">
            <h2>Pr√™t pour le d√©fi ? üî•</h2>
            
            <ul class="rules-list">
                <li>üéØ <strong>Questions infinies</strong> de toutes cat√©gories</li>
                <li>üìà <strong>Difficult√© progressive</strong> (facile ‚Üí difficile)</li>
                <li>‚ù§Ô∏è <strong>3 vies</strong> au d√©part</li>
                <li>‚ùå <strong>1 erreur = -1 vie</strong></li>
                <li>üèÜ <strong>Paliers √† d√©bloquer</strong> : D√©butant, Confirm√©, Expert, Ma√Ætre, L√©gende</li>
                <li>üåü <strong>Records</strong> personnels et mondiaux</li>
            </ul>
            
            <button class="start-btn" onclick="startGame()">üöÄ Commencer</button>
            
            <div class="leaderboard">
                <div class="leaderboard-title">üèÜ Top 10 Mondial</div>
                <div id="leaderboard-preview">
                    <div class="loading">Chargement...</div>
                </div>
            </div>
        </div>

        <!-- Section Question -->
        <div class="question-section" id="question-section">
            <div>
                <span class="question-number" id="question-counter">Question #1</span>
                <span class="difficulty-badge" id="difficulty-badge">Facile</span>
            </div>
            
            <div class="question-text" id="question-text"></div>
            
            <div id="answers-container"></div>
        </div>

        <!-- √âcran Game Over -->
        <div class="game-over-screen" id="game-over-screen">
            <h2>üéÆ GAME OVER</h2>
            
            <div class="final-score" id="final-score">0</div>
            
            <div class="achievement" id="achievement">
                <span id="achievement-badge">ü•â</span>
                <span id="achievement-title">D√©butant</span>
            </div>
            
            <div class="records-display">
                <div class="record-card">
                    <div class="record-title">Ton Record</div>
                    <div class="record-value" id="final-personal-record">0</div>
                </div>
                <div class="record-card">
                    <div class="record-title">Record Mondial</div>
                    <div class="record-value" id="final-world-record">0</div>
                </div>
            </div>
            
            <div style="display: flex; gap: 15px; justify-content: center; margin-top: 30px;">
                <button class="start-btn" onclick="location.reload()">
                    üîÑ Rejouer
                </button>
                <button class="start-btn" style="background: linear-gradient(135deg, #3498db, #2ecc71);" onclick="window.location.href='Accueil.html'">
                    üè† Accueil
                </button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentUser = null;
        let allQuestions = [];
        let currentQuestion = null;
        let currentScore = 0;
        let lives = 3;
        let personalRecord = 0;
        let worldRecord = 0;
        let selectedAnswer = null;

        // Paliers
        const MILESTONES = {
            0: { title: "D√©butant", badge: "ü•â" },
            10: { title: "Confirm√©", badge: "ü•à" },
            25: { title: "Expert", badge: "ü•á" },
            50: { title: "Ma√Ætre", badge: "üëë" },
            100: { title: "L√©gende", badge: "üåü" }
        };

        // Initialisation
        window.addEventListener('load', async () => {
            await waitForFirebase();
            
            firebase.auth().onAuthStateChanged(async (user) => {
                currentUser = user;
                
                if (user) {
                    await loadPersonalRecord();
                }
                
                await loadWorldRecord();
                await loadLeaderboard();
                await loadQuestions();
            });
        });

        // Attendre Firebase
        function waitForFirebase() {
            return new Promise((resolve) => {
                const check = setInterval(() => {
                    if (typeof firebase !== 'undefined' && firebase.auth) {
                        clearInterval(check);
                        resolve();
                    }
                }, 100);
            });
        }

        // Charger toutes les questions
        async function loadQuestions() {
            try {
                const snapshot = await firebase.firestore()
                    .collection('questionBank')
                    .get();

                allQuestions = snapshot.docs.map(doc => doc.data());
                
                if (allQuestions.length === 0) {
                    alert('‚ùå Aucune question trouv√©e. Veuillez importer les questions d\'abord.');
                }
            } catch (error) {
                console.error('Erreur chargement questions:', error);
                alert('‚ùå Erreur lors du chargement des questions');
            }
        }

        // Charger record personnel
        async function loadPersonalRecord() {
            if (!currentUser) return;

            try {
                const snapshot = await firebase.firestore()
                    .collection('survivalRecords')
                    .where('userId', '==', currentUser.uid)
                    .orderBy('score', 'desc')
                    .limit(1)
                    .get();

                if (!snapshot.empty) {
                    personalRecord = snapshot.docs[0].data().score;
                    document.getElementById('personal-record').textContent = personalRecord;
                }
            } catch (error) {
                console.error('Erreur chargement record perso:', error);
            }
        }

        // Charger record mondial
        async function loadWorldRecord() {
            try {
                const snapshot = await firebase.firestore()
                    .collection('survivalRecords')
                    .orderBy('score', 'desc')
                    .limit(1)
                    .get();

                if (!snapshot.empty) {
                    const record = snapshot.docs[0].data();
                    worldRecord = record.score;
                    document.getElementById('world-record').textContent = 
                        `${worldRecord} (${record.pseudo || 'Anonyme'})`;
                    document.getElementById('final-world-record').textContent = worldRecord;
                }
            } catch (error) {
                console.error('Erreur chargement record mondial:', error);
            }
        }

        // Charger leaderboard
        async function loadLeaderboard() {
            const container = document.getElementById('leaderboard-preview');
            
            try {
                const snapshot = await firebase.firestore()
                    .collection('survivalRecords')
                    .orderBy('score', 'desc')
                    .limit(10)
                    .get();

                if (snapshot.empty) {
                    container.innerHTML = '<p style="text-align: center; color: #7f8c8d;">Aucun record pour l\'instant. Soyez le premier !</p>';
                    return;
                }

                container.innerHTML = '';
                snapshot.forEach((doc, index) => {
                    const data = doc.data();
                    const item = document.createElement('div');
                    item.className = 'leaderboard-item';
                    
                    if (currentUser && data.userId === currentUser.uid) {
                        item.classList.add('current-user');
                    }
                    
                    const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '';
                    
                    item.innerHTML = `
                        <span>${medal || (index + 1)}. ${data.pseudo || 'Joueur'}</span>
                        <span style="font-weight: bold; color: #e74c3c;">${data.score}</span>
                    `;
                    
                    container.appendChild(item);
                });
            } catch (error) {
                console.error('Erreur leaderboard:', error);
                container.innerHTML = '<p style="color: #e74c3c;">Erreur de chargement</p>';
            }
        }

        // D√©marrer le jeu
        function startGame() {
            if (!currentUser) {
                if (confirm('Connectez-vous pour sauvegarder votre score !')) {
                    window.location.href = 'Auth.html';
                }
                return;
            }

            if (allQuestions.length === 0) {
                alert('‚ùå Aucune question disponible. Veuillez importer les questions.');
                return;
            }

            currentScore = 0;
            lives = 3;
            selectedAnswer = null;
            
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('progress-section').style.display = 'block';
            document.getElementById('question-section').classList.add('active');
            
            updateDisplay();
            loadNextQuestion();
        }

        // Charger la question suivante
        function loadNextQuestion() {
            // D√©terminer la difficult√© en fonction du score
            let difficulty;
            if (currentScore < 10) {
                difficulty = 'facile';
            } else if (currentScore < 25) {
                difficulty = 'moyen';
            } else {
                difficulty = 'difficile';
            }

            // Filtrer les questions par difficult√©
            let filteredQuestions = allQuestions.filter(q => q.difficulty === difficulty);
            
            // Si pas assez de questions de cette difficult√©, prendre toutes les questions
            if (filteredQuestions.length === 0) {
                filteredQuestions = allQuestions;
            }

            // S√©lectionner une question al√©atoire
            currentQuestion = filteredQuestions[Math.floor(Math.random() * filteredQuestions.length)];
            
            displayQuestion();
        }

        // Afficher la question
        function displayQuestion() {
            document.getElementById('question-counter').textContent = `Question #${currentScore + 1}`;
            document.getElementById('difficulty-badge').textContent = capitalizeFirst(currentQuestion.difficulty);
            document.getElementById('difficulty-badge').className = `difficulty-badge ${currentQuestion.difficulty}`;
            document.getElementById('question-text').textContent = currentQuestion.question;
            
            const container = document.getElementById('answers-container');
            container.innerHTML = '';
            
            // M√©langer les r√©ponses al√©atoirement
            const shuffledAnswers = currentQuestion.answers.map((answer, i) => ({ text: answer, originalIndex: i }));
            for (let i = shuffledAnswers.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffledAnswers[i], shuffledAnswers[j]] = [shuffledAnswers[j], shuffledAnswers[i]];
            }
            // Stocker le mapping pour la validation
            currentQuestion.shuffledAnswers = shuffledAnswers;
            
            shuffledAnswers.forEach((ans, index) => {
                const option = document.createElement('label');
                option.className = 'answer-option';
                option.onclick = () => validateAnswer(index);
                option.innerHTML = ans.text;
                container.appendChild(option);
            });
            
            answerValidated = false;
        }

        // Variable pour √©viter double validation
        let answerValidated = false;

        // Valider la r√©ponse au clic direct
        function validateAnswer(index) {
            if (answerValidated) return;
            answerValidated = true;
            
            const options = document.querySelectorAll('.answer-option');
            
            // S√©lectionner visuellement
            options.forEach((opt, i) => {
                opt.classList.remove('selected');
                if (i === index) {
                    opt.classList.add('selected');
                }
            });
            
            // Trouver l'index original de la r√©ponse s√©lectionn√©e via le mapping
            const originalSelectedIndex = currentQuestion.shuffledAnswers[index].originalIndex;
            const isCorrect = originalSelectedIndex === currentQuestion.correct;
            
            // Trouver l'index affich√© de la bonne r√©ponse
            const correctDisplayIndex = currentQuestion.shuffledAnswers.findIndex(a => a.originalIndex === currentQuestion.correct);
            
            if (isCorrect) {
                // Bonne r√©ponse
                options[index].classList.add('correct');
                currentScore++;
                
                setTimeout(() => {
                    updateDisplay();
                    loadNextQuestion();
                }, 1000);
            } else {
                // Mauvaise r√©ponse
                options[index].classList.add('incorrect');
                options[correctDisplayIndex].classList.add('correct');
                lives--;
                
                setTimeout(() => {
                    if (lives === 0) {
                        gameOver();
                    } else {
                        updateDisplay();
                        loadNextQuestion();
                    }
                }, 1500);
            }
        }

        // Mettre √† jour l'affichage
        function updateDisplay() {
            // Score
            document.getElementById('current-score').textContent = currentScore;
            
            // Vies
            const heartsDisplay = '‚ù§Ô∏è'.repeat(lives) + 'üñ§'.repeat(3 - lives);
            document.getElementById('lives-display').textContent = heartsDisplay;
            
            // Badge et progression
            const currentMilestone = getCurrentMilestone();
            const nextMilestone = getNextMilestone();
            
            if (currentMilestone) {
                document.getElementById('current-badge').innerHTML = `
                    <span class="badge-icon">${currentMilestone.badge}</span>
                    <span>${currentMilestone.title}</span>
                `;
            }
            
            if (nextMilestone) {
                const progress = ((currentScore - currentMilestone.threshold) / (nextMilestone.threshold - currentMilestone.threshold)) * 100;
                const remaining = nextMilestone.threshold - currentScore;
                
                document.getElementById('progress-bar').style.width = progress + '%';
                document.getElementById('progress-bar').textContent = `${currentScore}/${nextMilestone.threshold}`;
                document.getElementById('next-milestone').textContent = 
                    `Prochain palier : ${nextMilestone.title} (${remaining} question${remaining > 1 ? 's' : ''}) ${nextMilestone.badge}`;
            } else {
                // Palier maximum atteint
                document.getElementById('progress-bar').style.width = '100%';
                document.getElementById('progress-bar').textContent = 'MAX';
                document.getElementById('next-milestone').textContent = 
                    'üåü Palier maximum atteint ! Continuez pour battre le record !';
            }
        }

        // Obtenir le palier actuel
        function getCurrentMilestone() {
            const thresholds = Object.keys(MILESTONES).map(Number).sort((a, b) => b - a);
            
            for (const threshold of thresholds) {
                if (currentScore >= threshold) {
                    return {
                        threshold: threshold,
                        title: MILESTONES[threshold].title,
                        badge: MILESTONES[threshold].badge
                    };
                }
            }
            
            return {
                threshold: 0,
                title: MILESTONES[0].title,
                badge: MILESTONES[0].badge
            };
        }

        // Obtenir le prochain palier
        function getNextMilestone() {
            const thresholds = Object.keys(MILESTONES).map(Number).sort((a, b) => a - b);
            
            for (const threshold of thresholds) {
                if (currentScore < threshold) {
                    return {
                        threshold: threshold,
                        title: MILESTONES[threshold].title,
                        badge: MILESTONES[threshold].badge
                    };
                }
            }
            
            return null;
        }

        // Game Over
        async function gameOver() {
            document.getElementById('question-section').classList.remove('active');
            document.getElementById('progress-section').style.display = 'none';
            document.getElementById('game-over-screen').classList.add('active');
            
            // Afficher le score final
            document.getElementById('final-score').textContent = currentScore;
            
            // Afficher le palier atteint
            const milestone = getCurrentMilestone();
            document.getElementById('achievement-badge').textContent = milestone.badge;
            document.getElementById('achievement-title').textContent = milestone.title;
            
            // Afficher les records
            document.getElementById('final-personal-record').textContent = 
                Math.max(currentScore, personalRecord);
            
            // Sauvegarder le score
            if (currentUser) {
                await saveScore();
            }
        }

        // Sauvegarder le score
        async function saveScore() {
            try {
                await firebase.firestore()
                    .collection('survivalRecords')
                    .add({
                        userId: currentUser.uid,
                        pseudo: currentUser.displayName || 'Joueur',
                        score: currentScore,
                        timestamp: new Date()
                    });

                // Recharger les records
                await loadPersonalRecord();
                await loadWorldRecord();
            } catch (error) {
                console.error('Erreur sauvegarde score:', error);
            }
        }

        // Utilitaires
        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
    </script>
</body>
</html>