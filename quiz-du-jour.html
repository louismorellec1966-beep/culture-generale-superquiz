<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìÖ Quiz du Jour - SuperQuiz</title>
    <link rel="stylesheet" href="CSS/style.css">
    
    <!-- Firebase SDK -->
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script defer src="firebase-config.js"></script>
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            padding-top: 40px;
        }

        .daily-quiz-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .daily-header {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .daily-header h1 {
            font-size: 2.5em;
            margin: 0 0 10px 0;
            color: #2c3e50;
        }

        .daily-date {
            font-size: 1.2em;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        .daily-theme {
            background: linear-gradient(135deg, #3498db, #2ecc71);
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.3em;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 20px;
        }

        .daily-stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
        }

        .stat-label {
            font-size: 0.9em;
            color: #7f8c8d;
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }

        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .quiz-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .leaderboard-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 20px;
            max-height: 600px;
            overflow-y: auto;
        }

        .leaderboard-title {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #2c3e50;
            text-align: center;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .leaderboard-item:hover {
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .leaderboard-item.top-1 {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            font-weight: bold;
        }

        .leaderboard-item.top-2 {
            background: linear-gradient(135deg, #c0c0c0, #e8e8e8);
        }

        .leaderboard-item.top-3 {
            background: linear-gradient(135deg, #cd7f32, #e6b87a);
        }

        .leaderboard-item.current-user {
            border: 3px solid #3498db;
            background: #e3f2fd;
        }

        .rank {
            font-size: 1.5em;
            font-weight: bold;
            margin-right: 15px;
            min-width: 40px;
            text-align: center;
        }

        .player-info {
            flex: 1;
        }

        .player-name {
            font-weight: bold;
            color: #2c3e50;
        }

        .player-score {
            font-size: 0.9em;
            color: #7f8c8d;
        }

        .player-time {
            font-weight: bold;
            color: #e74c3c;
            white-space: nowrap;
        }

        .question-card {
            background: #f8f9fa;
            border: 2px solid #3498db;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .question-number {
            background: #3498db;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            display: inline-block;
            margin-bottom: 10px;
        }

        .question-text {
            font-size: 1.2em;
            font-weight: bold;
            margin: 15px 0;
            color: #2c3e50;
        }

        .answer-option {
            display: block;
            margin: 12px 0;
            padding: 15px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .answer-option:hover {
            background: #f8f9fa;
            border-color: #3498db;
            transform: translateX(5px);
        }

        .answer-option.selected {
            background: #e3f2fd;
            border-color: #3498db;
        }

        .answer-option.correct {
            background: #d4edda;
            border-color: #28a745;
        }

        .answer-option.incorrect {
            background: #f8d7da;
            border-color: #dc3545;
        }

        .answer-option input[type="radio"] {
            margin-right: 10px;
            cursor: pointer;
        }

        .validate-btn {
            background: linear-gradient(135deg, #3498db, #2ecc71);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .validate-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .validate-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .timer-display {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #e74c3c, #f39c12);
            color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            text-align: center;
            min-width: 120px;
        }

        .timer-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .timer-value {
            font-size: 2em;
            font-weight: bold;
            margin-top: 5px;
        }

        .results-screen {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .results-screen.active {
            display: block;
        }

        .score-big {
            font-size: 4em;
            font-weight: bold;
            color: #3498db;
            margin: 20px 0;
        }

        .share-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .share-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }

        .share-twitter {
            background: #1da1f2;
        }

        .share-facebook {
            background: #4267B2;
        }

        .share-copy {
            background: #95a5a6;
        }

        .share-btn:hover {
            transform: scale(1.1);
        }

        .start-btn {
            background: linear-gradient(135deg, #3498db, #2ecc71);
            color: white;
            border: none;
            padding: 20px 50px;
            border-radius: 30px;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .start-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.4);
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #7f8c8d;
        }

        .already-played {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .previous-score {
            font-size: 1.5em;
            font-weight: bold;
            color: #3498db;
            margin: 10px 0;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <!-- Menu Navigation -->
    <nav style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 15px; margin-bottom: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
        <ul style="list-style: none; display: flex; gap: 30px; margin: 0; padding: 0; flex-wrap: wrap; align-items: center; justify-content: center;">
            <li><a href="Accueil.html" style="color: white; text-decoration: none; font-size: 1.1em; font-weight: 500; transition: all 0.3s; padding: 8px 15px; border-radius: 8px; display: inline-block;">üè† Accueil</a></li>
            <li><a href="quiz-du-jour.html" style="color: #ffd700; text-decoration: none; font-size: 1.1em; font-weight: bold; text-shadow: 0 0 10px rgba(255,215,0,0.5); padding: 8px 15px; border-radius: 8px; display: inline-block; background: rgba(255,255,255,0.1);">üìÖ Quiz du Jour</a></li>
            <li><a href="mode-survie.html" style="color: white; text-decoration: none; font-size: 1.1em; font-weight: 500; transition: all 0.3s; padding: 8px 15px; border-radius: 8px; display: inline-block;">üéÆ Mode Survie</a></li>
            <li><a href="Scores.html" style="color: white; text-decoration: none; font-size: 1.1em; font-weight: 500; transition: all 0.3s; padding: 8px 15px; border-radius: 8px; display: inline-block;">üèÜ Mes Scores</a></li>
        </ul>
    </nav>

    <div class="daily-quiz-container" style="margin-top: 0; padding-top: 20px;">
        <!-- En-t√™te du Quiz du Jour -->
        <div class="daily-header">
            <h1>üìÖ Quiz du Jour</h1>
            <div class="daily-date" id="daily-date"></div>
            <div class="daily-theme" id="daily-theme">Chargement...</div>
            
            <div class="daily-stats">
                <div class="stat-item">
                    <div class="stat-number" id="participants-count">0</div>
                    <div class="stat-label">Participants</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="questions-count">10</div>
                    <div class="stat-label">Questions</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="top-score">-</div>
                    <div class="stat-label">Meilleur Score</div>
                </div>
            </div>
        </div>

        <!-- Contenu Principal -->
        <div class="main-content">
            <!-- Section Quiz -->
            <div class="quiz-section">
                <!-- √âcran de d√©marrage -->
                <div id="start-screen">
                    <div class="loading" id="loading-screen">
                        <p>‚è≥ Chargement du quiz du jour...</p>
                    </div>
                    
                    <div id="ready-screen" style="display: none; text-align: center;">
                        <h2>Pr√™t √† jouer ? üéØ</h2>
                        <p style="margin: 20px 0; font-size: 1.1em; color: #7f8c8d;">
                            R√©pondez aux 10 questions le plus rapidement possible.<br>
                            Votre temps sera enregistr√© pour le classement !
                        </p>
                        <button class="start-btn pulse" onclick="startQuiz()">
                            üöÄ Commencer le Quiz
                        </button>
                    </div>

                    <div id="already-played-screen" style="display: none;">
                        <div class="already-played">
                            <h2>‚úÖ Vous avez d√©j√† fait le quiz d'aujourd'hui !</h2>
                            <div class="previous-score" id="previous-score"></div>
                            <p style="margin-top: 20px;">
                                Revenez demain pour un nouveau quiz ! üòä
                            </p>
                        </div>
                    </div>
                </div>

                <!-- √âcran du Quiz -->
                <div id="quiz-screen" style="display: none;">
                    <div id="questions-container"></div>
                    <button class="validate-btn" onclick="submitQuiz()" style="display: block; margin: 30px auto;">
                        ‚úÖ Terminer le Quiz
                    </button>
                </div>

                <!-- √âcran des R√©sultats -->
                <div id="results-screen" class="results-screen">
                    <h2>üéâ Quiz Termin√© !</h2>
                    <div class="score-big" id="final-score"></div>
                    <p style="font-size: 1.2em; color: #7f8c8d;">
                        Temps total : <span id="final-time" style="color: #e74c3c; font-weight: bold;"></span>
                    </p>
                    <p style="font-size: 1.1em; color: #7f8c8d; margin-top: 20px;">
                        Votre rang : <span id="final-rank" style="color: #3498db; font-weight: bold;"></span>
                    </p>

                    <div class="share-buttons">
                        <button class="share-btn share-twitter" onclick="shareTwitter()">
                            üê¶ Twitter
                        </button>
                        <button class="share-btn share-facebook" onclick="shareFacebook()">
                            üìò Facebook
                        </button>
                        <button class="share-btn share-copy" onclick="copyResult()">
                            üìã Copier
                        </button>
                    </div>

                    <button class="start-btn" onclick="location.reload()" style="margin-top: 30px;">
                        üîÑ Voir le Classement
                    </button>
                </div>
            </div>

            <!-- Section Leaderboard -->
            <div class="leaderboard-section">
                <h2 class="leaderboard-title">üèÜ Classement du Jour</h2>
                <div id="leaderboard-container">
                    <div class="loading">
                        Chargement du classement...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Timer Flottant -->
    <div class="timer-display" id="timer-display" style="display: none;">
        <div class="timer-label">‚è±Ô∏è Temps</div>
        <div class="timer-value" id="timer-value">0:00</div>
    </div>

    <script>
        let dailyQuizData = null;
        let startTime = null;
        let timerInterval = null;
        let currentUser = null;
        let userAnswers = {};

        // Obtenir la date du jour au format YYYY-MM-DD
        function getTodayDate() {
            const today = new Date();
            return today.toISOString().split('T')[0];
        }

        // Formater la date pour l'affichage
        function formatDate(dateString) {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('fr-FR', options);
        }

        // Initialisation au chargement
        window.addEventListener('load', async () => {
            // Afficher la date
            const today = getTodayDate();
            document.getElementById('daily-date').textContent = formatDate(today);

            // Attendre Firebase
            await waitForFirebase();

            // V√©rifier l'authentification
            FirebaseAuth.onAuthStateChanged(async (user) => {
                currentUser = user;
                
                if (user) {
                    // Mettre √† jour le menu
                    updateAuthMenu(user);
                    
                    // V√©rifier si l'utilisateur a d√©j√† jou√©
                    const hasPlayed = await checkIfUserPlayed(today);
                    
                    if (hasPlayed) {
                        showAlreadyPlayed(hasPlayed);
                    } else {
                        // Charger le quiz
                        await loadDailyQuiz(today);
                    }
                } else {
                    // Charger le quiz quand m√™me pour voir le th√®me
                    await loadDailyQuiz(today);
                }

                // Charger le leaderboard
                loadLeaderboard(today);
            });
        });

        // Attendre que Firebase soit charg√©
        function waitForFirebase() {
            return new Promise((resolve) => {
                const checkFirebase = setInterval(() => {
                    if (typeof FirebaseAuth !== 'undefined' && typeof firebase !== 'undefined') {
                        clearInterval(checkFirebase);
                        resolve();
                    }
                }, 100);
            });
        }

        // V√©rifier si l'utilisateur a d√©j√† jou√© aujourd'hui
        async function checkIfUserPlayed(date) {
            if (!currentUser) return null;

            try {
                const snapshot = await firebase.firestore()
                    .collection('dailyQuizScores')
                    .where('date', '==', date)
                    .where('userId', '==', currentUser.uid)
                    .get();

                if (!snapshot.empty) {
                    return snapshot.docs[0].data();
                }
                return null;
            } catch (error) {
                console.error('Erreur v√©rification:', error);
                return null;
            }
        }

        // Afficher l'√©cran "d√©j√† jou√©"
        function showAlreadyPlayed(scoreData) {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('already-played-screen').style.display = 'block';
            document.getElementById('previous-score').textContent = 
                `${scoreData.score}/10 en ${scoreData.time}s`;
        }

        // Charger le quiz du jour
        async function loadDailyQuiz(date) {
            try {
                // R√©cup√©rer le quiz du jour depuis Firestore
                const quizDoc = await firebase.firestore()
                    .collection('dailyQuiz')
                    .doc(date)
                    .get();

                if (quizDoc.exists) {
                    dailyQuizData = quizDoc.data();
                } else {
                    // Cr√©er un nouveau quiz pour aujourd'hui
                    dailyQuizData = await generateDailyQuiz(date);
                }

                // Afficher le th√®me
                document.getElementById('daily-theme').textContent = 
                    `üéØ ${dailyQuizData.theme}`;
                document.getElementById('questions-count').textContent = 
                    dailyQuizData.questions.length;

                // Afficher l'√©cran de d√©marrage
                document.getElementById('loading-screen').style.display = 'none';
                
                if (currentUser) {
                    document.getElementById('ready-screen').style.display = 'block';
                } else {
                    // Inviter √† se connecter
                    document.getElementById('ready-screen').innerHTML = `
                        <h2>üîê Connexion requise</h2>
                        <p style="margin: 20px 0; font-size: 1.1em; color: #7f8c8d;">
                            Connectez-vous pour participer au Quiz du Jour<br>
                            et appara√Ætre dans le classement !
                        </p>
                        <button class="start-btn" onclick="window.location.href='Auth.html'">
                            üöÄ Se Connecter
                        </button>
                    `;
                    document.getElementById('ready-screen').style.display = 'block';
                }

            } catch (error) {
                console.error('Erreur chargement quiz:', error);
                alert('‚ùå Erreur lors du chargement du quiz');
            }
        }

        // G√©n√©rer un nouveau quiz quotidien
        async function generateDailyQuiz(date) {
            const CATEGORIES = {
                histoire: { antiquite: 'Antiquit√©', moyenage: 'Moyen √Çge', art: "Histoire de l'Art", guerres: 'Guerres Mondiales', france: 'Histoire de France', contemporaine: 'Histoire Contemporaine', pr√©histoire: 'Pr√©histoire' },
                geographie: { capitales: 'Capitales du Monde', france: 'G√©ographie de France', europe: 'Europe', continents: 'Continents & Oc√©ans', nature: 'G√©ographie Physique', culture: 'G√©ographie Culturelle' },
                science: { physique: 'Physique', chimie: 'Chimie', biologie: 'Biologie', astronomie: 'Astronomie', mathematiques: 'Math√©matiques', technologie: 'Technologie' },
                litterature: { classiques: 'Classiques Fran√ßais', poesie: 'Po√©sie', theatre: 'Th√©√¢tre', romans: 'Romans du XXe si√®cle', mondiale: 'Litt√©rature Mondiale', contemporaine: 'Litt√©rature Contemporaine' },
                sport: { football: 'Football', basketball: 'Basketball', tennis: 'Tennis', athletisme: 'Athl√©tisme', natation: 'Natation', 'jeux-olympiques': 'Jeux Olympiques' }
            };

            // Aplatir les cat√©gories pour en choisir une au hasard
            const flatCategories = [];
            for (const matiere in CATEGORIES) {
                for (const categorie in CATEGORIES[matiere]) {
                    flatCategories.push({
                        matiere: matiere,
                        categorie: categorie,
                        nom: CATEGORIES[matiere][categorie]
                    });
                }
            }

            // Choisir une cat√©gorie bas√©e sur la date
            const dayIndex = new Date(date).getDate();
            const chosenCategory = flatCategories[dayIndex % flatCategories.length];

            const matiere = chosenCategory.matiere;
            const categorie = chosenCategory.categorie;
            const theme = chosenCategory.nom;

            try {
                const questionsSnapshot = await firebase.firestore()
                    .collection('questionBank')
                    .where('matiere', '==', matiere)
                    .where('categorie', '==', categorie)
                    .get();

                if (questionsSnapshot.empty) {
                    console.error('Aucune question trouv√©e pour le th√®me:', theme);
                    alert('‚ùå Aucune question disponible pour ce th√®me. Veuillez importer les questions.');
                    return null;
                }

                const allQuestions = questionsSnapshot.docs.map(doc => {
                    const data = doc.data();
                    // Assurer la compatibilit√© entre "reponses" et "answers"
                    if (!data.reponses && data.answers) {
                        data.reponses = data.answers;
                    }
                    return data;
                });
                
                // S√©lectionner 10 questions al√©atoires
                const questions = shuffleArray(allQuestions).slice(0, 10);

                if (questions.length < 10) {
                    console.warn(`Seulement ${questions.length} questions disponibles pour ${theme}`);
                }

                const quizData = {
                    date: date,
                    theme: theme,
                    questions: questions.map(({answers, ...rest}) => rest), // Nettoyer l'ancien champ 'answers'
                    createdAt: new Date()
                };

                // Sauvegarder dans Firestore
                await firebase.firestore()
                    .collection('dailyQuiz')
                    .doc(date)
                    .set(quizData);

                return quizData;
                
            } catch (error) {
                console.error('Erreur chargement questions:', error);
                alert('‚ùå Erreur lors du chargement des questions. Un index Firestore est peut-√™tre manquant. V√©rifiez la console (F12).');
                return null;
            }
        }

        // M√©langer un tableau
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // D√©marrer le quiz
        function startQuiz() {
            // Masquer l'√©cran de d√©marrage
            document.getElementById('start-screen').style.display = 'none';
            
            // Afficher le quiz
            document.getElementById('quiz-screen').style.display = 'block';
            
            // Afficher les questions
            displayQuestions();
            
            // D√©marrer le chronom√®tre
            startTime = Date.now();
            document.getElementById('timer-display').style.display = 'block';
            
            timerInterval = setInterval(updateTimer, 100);
        }

        // Afficher les questions
        function displayQuestions() {
            const container = document.getElementById('questions-container');
            container.innerHTML = '';

            dailyQuizData.questions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-card';
                questionDiv.innerHTML = `
                    <div class="question-number">Question ${index + 1}/10</div>
                    <div class="question-text">${q.question}</div>
                    ${q.answers.map((answer, i) => `
                        <label class="answer-option" onclick="selectAnswer(${index}, ${i})">
                            <input type="radio" name="q${index}" value="${i}" id="q${index}_r${i}">
                            ${answer}
                        </label>
                    `).join('')}
                `;
                container.appendChild(questionDiv);
            });
        }

        // S√©lectionner une r√©ponse
        function selectAnswer(qIndex, answerIndex) {
            userAnswers[qIndex] = answerIndex;
            
            const radio = document.getElementById(`q${qIndex}_r${answerIndex}`);
            radio.checked = true;
            
            // Mettre √† jour le style
            document.querySelectorAll(`input[name="q${qIndex}"]`).forEach(r => {
                r.closest('.answer-option').classList.remove('selected');
            });
            radio.closest('.answer-option').classList.add('selected');
        }

        // Mettre √† jour le chronom√®tre
        function updateTimer() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            document.getElementById('timer-value').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // Soumettre le quiz
        async function submitQuiz() {
            // V√©rifier que toutes les questions ont une r√©ponse
            if (Object.keys(userAnswers).length < dailyQuizData.questions.length) {
                alert('‚ö†Ô∏è Veuillez r√©pondre √† toutes les questions !');
                return;
            }

            // Arr√™ter le chronom√®tre
            clearInterval(timerInterval);
            const totalTime = Math.floor((Date.now() - startTime) / 1000);

            // Calculer le score
            let score = 0;
            dailyQuizData.questions.forEach((q, index) => {
                if (userAnswers[index] === q.correct) {
                    score++;
                }
            });

            // Sauvegarder le score
            await saveDailyScore(score, totalTime);

            // Afficher les r√©sultats
            showResults(score, totalTime);
        }

        // Sauvegarder le score dans Firestore
        async function saveDailyScore(score, time) {
            if (!currentUser) return;

            const today = getTodayDate();
            
            try {
                await firebase.firestore()
                    .collection('dailyQuizScores')
                    .add({
                        userId: currentUser.uid,
                        pseudo: currentUser.displayName || 'Joueur',
                        date: today,
                        score: score,
                        time: time,
                        timestamp: new Date()
                    });

                // Recharger le leaderboard
                loadLeaderboard(today);
            } catch (error) {
                console.error('Erreur sauvegarde score:', error);
            }
        }

        // Afficher les r√©sultats
        function showResults(score, time) {
            document.getElementById('quiz-screen').style.display = 'none';
            document.getElementById('timer-display').style.display = 'none';
            
            const resultsScreen = document.getElementById('results-screen');
            resultsScreen.classList.add('active');
            
            document.getElementById('final-score').textContent = `${score}/10`;
            document.getElementById('final-time').textContent = `${time}s`;
            
            // Calculer le rang (sera mis √† jour apr√®s rechargement du leaderboard)
            setTimeout(async () => {
                const rank = await getUserRank(getTodayDate());
                document.getElementById('final-rank').textContent = `#${rank}`;
            }, 1000);
        }

        // Obtenir le rang de l'utilisateur
        async function getUserRank(date) {
            if (!currentUser) return '-';

            try {
                const snapshot = await firebase.firestore()
                    .collection('dailyQuizScores')
                    .where('date', '==', date)
                    .orderBy('score', 'desc')
                    .orderBy('time', 'asc')
                    .get();

                let rank = 1;
                for (const doc of snapshot.docs) {
                    if (doc.data().userId === currentUser.uid) {
                        return rank;
                    }
                    rank++;
                }
                return '-';
            } catch (error) {
                console.error('Erreur calcul rang:', error);
                return '-';
            }
        }

        // Charger le leaderboard
        async function loadLeaderboard(date) {
            const container = document.getElementById('leaderboard-container');
            
            try {
                const snapshot = await firebase.firestore()
                    .collection('dailyQuizScores')
                    .where('date', '==', date)
                    .orderBy('score', 'desc')
                    .orderBy('time', 'asc')
                    .limit(50)
                    .get();

                if (snapshot.empty) {
                    container.innerHTML = '<p style="text-align: center; color: #7f8c8d;">Aucun participant pour l\'instant. Soyez le premier ! üöÄ</p>';
                    return;
                }

                container.innerHTML = '';
                
                // Mettre √† jour le nombre de participants
                document.getElementById('participants-count').textContent = snapshot.size;
                
                // Afficher le meilleur score
                const topScore = snapshot.docs[0].data();
                document.getElementById('top-score').textContent = 
                    `${topScore.score}/10`;

                snapshot.forEach((doc, index) => {
                    const data = doc.data();
                    const rank = index + 1;
                    
                    const item = document.createElement('div');
                    item.className = 'leaderboard-item';
                    
                    if (rank === 1) item.classList.add('top-1');
                    else if (rank === 2) item.classList.add('top-2');
                    else if (rank === 3) item.classList.add('top-3');
                    
                    if (currentUser && data.userId === currentUser.uid) {
                        item.classList.add('current-user');
                    }
                    
                    const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : '';
                    
                    item.innerHTML = `
                        <div class="rank">${medal || rank}</div>
                        <div class="player-info">
                            <div class="player-name">${data.pseudo}</div>
                            <div class="player-score">${data.score}/10</div>
                        </div>
                        <div class="player-time">${data.time}s</div>
                    `;
                    
                    container.appendChild(item);
                });

            } catch (error) {
                console.error('Erreur chargement leaderboard:', error);
                container.innerHTML = '<p style="text-align: center; color: #e74c3c;">Erreur de chargement</p>';
            }
        }

        // Partage sur Twitter
        function shareTwitter() {
            const score = document.getElementById('final-score').textContent;
            const time = document.getElementById('final-time').textContent;
            const text = `J'ai fait ${score} au Quiz du Jour en ${time} sur SuperQuiz ! üéØ\nPeux-tu faire mieux ?`;
            const url = window.location.href;
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, '_blank');
        }

        // Partage sur Facebook
        function shareFacebook() {
            const url = window.location.href;
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`, '_blank');
        }

        // Copier le r√©sultat
        function copyResult() {
            const score = document.getElementById('final-score').textContent;
            const time = document.getElementById('final-time').textContent;
            const text = `J'ai fait ${score} au Quiz du Jour en ${time} sur SuperQuiz ! üéØ\nPeux-tu faire mieux ?\n${window.location.href}`;
            
            navigator.clipboard.writeText(text).then(() => {
                alert('‚úÖ R√©sultat copi√© dans le presse-papier !');
            });
        }

        // Mettre √† jour le menu d'authentification
        function updateAuthMenu(user) {
            const nav = document.querySelector('.menu');
            if (!nav) return;

            const existingAuthItem = document.getElementById('auth-menu-item');
            if (existingAuthItem) existingAuthItem.remove();

            const authItem = document.createElement('li');
            authItem.id = 'auth-menu-item';

            if (user) {
                authItem.innerHTML = `
                    <a href="#" onclick="logout(event)" style="color: #2ecc71; text-decoration: none;">
                        üë§ ${user.displayName || 'Joueur'} <span style="font-size: 0.8em;">(D√©co)</span>
                    </a>
                `;
            } else {
                authItem.innerHTML = '<a href="Auth.html" style="color: #e74c3c; text-decoration: none;">üîê Connexion</a>';
            }

            nav.appendChild(authItem);
        }

        // D√©connexion
        async function logout(event) {
            event.preventDefault();
            if (confirm('Voulez-vous vraiment vous d√©connecter ?')) {
                try {
                    await FirebaseAuth.logout();
                    location.reload();
                } catch (error) {
                    alert('Erreur lors de la d√©connexion');
                }
            }
        }
    </script>
</body>
</html>