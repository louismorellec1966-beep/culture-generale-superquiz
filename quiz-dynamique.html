<!DOCTYPE html>
<html lang="fr">

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-G3YEKJLDRT"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-G3YEKJLDRT');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SuperQuiz - Quiz Dynamique</title>
    <link rel="stylesheet" href="CSS/style.css">

    <!-- Firebase SDK -->
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script defer src="firebase-config.js"></script>
    <script defer src="js/profile-system.js"></script>

    <style>
        .quiz-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 10px;
        }

        .quiz-header h1 {
            margin: 0;
            font-size: 2em;
        }

        .breadcrumb {
            margin: 20px 0;
            font-size: 0.9em;
        }

        .breadcrumb a {
            color: #3498db;
            text-decoration: none;
        }

        .score-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            font-size: 1.2em;
            font-weight: bold;
        }

        .score-display span {
            font-size: 1.3em;
            color: #ffd700;
        }

        .question-card {
            background: white;
            border: 2px solid #3498db;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .question-number {
            background: #3498db;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .question-text {
            font-size: 1.2em;
            margin: 20px 0;
            color: #2c3e50;
            font-weight: 500;
        }

        .answer-option {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .answer-option:hover {
            background: #e8f4fd;
            border-color: #3498db;
        }

        .answer-option.selected {
            background: #e8f4fd;
            border-color: #3498db;
        }

        .answer-option input[type="radio"] {
            margin-right: 15px;
            transform: scale(1.3);
        }

        .answer-option label {
            cursor: pointer;
            flex: 1;
            font-size: 1em;
        }

        .btn-valider {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: transform 0.2s;
        }

        .btn-valider:hover {
            transform: scale(1.05);
        }

        .reponse-feedback {
            display: none;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-weight: bold;
        }

        .reponse-feedback.correct {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .reponse-feedback.incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .global-timer {
            position: fixed;
            top: 100px;
            right: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.2);
            z-index: 100;
            display: none;
        }

        .global-timer.active {
            display: block;
        }

        .timer-value {
            font-size: 1.5em;
            font-weight: bold;
        }

        .mode-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .mode-badge.classic {
            background: #3498db;
        }

        .mode-badge.challenge {
            background: #e74c3c;
        }

        .error-message {
            text-align: center;
            padding: 50px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .error-message h2 {
            color: #e74c3c;
        }

        /* Modal R√©sultats */
        .results-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .results-modal.active {
            display: flex;
        }

        .results-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            animation: popIn 0.3s ease;
        }

        @keyframes popIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .results-header {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .results-score {
            font-size: 3em;
            font-weight: bold;
            color: #2c3e50;
        }

        .results-percentage {
            font-size: 1.5em;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        .xp-gain {
            background: linear-gradient(135deg, #f1c40f, #f39c12);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .xp-gain-title {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .xp-gain-value {
            font-size: 1.8em;
            font-weight: bold;
        }

        .level-up {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: bold;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        .new-badges {
            margin: 15px 0;
        }

        .badge-earned {
            display: inline-block;
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 10px;
            margin: 5px;
            border: 2px solid #f1c40f;
        }

        .results-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .btn-result {
            padding: 12px 25px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-result:hover {
            transform: scale(1.05);
        }

        .btn-result.primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-result.secondary {
            background: #ecf0f1;
            color: #2c3e50;
        }
    </style>
</head>

<body>
    <nav aria-label="Navigation principale">
        <button id="toggle-menu" aria-label="Ouvrir le menu">
            <span class="hamburger"></span>
            <span class="hamburger"></span>
            <span class="hamburger"></span>
        </button>

        <ul class="menu">
            <li><a href="Accueil.html">Accueil</a></li>
            <li class="dropdown">
                <a href="Quiz.html">Quiz</a>
                <ul class="submenu">
                    <li><a href="Histoire.html">Histoire</a></li>
                    <li><a href="G√©ographie.html">G√©ographie</a></li>
                    <li><a href="Science.html">Science</a></li>
                    <li><a href="Litt√©rature.html">Litt√©rature</a></li>
                    <li><a href="Sport.html">Sport</a></li>
                </ul>
            </li>
            <li><a href="Scores.html">Scores</a></li>
            <li><a href="quiz-du-jour.html">üìÖ Quiz du Jour</a></li>
            <li><a href="mode-survie.html">üéÆ Mode Survie</a></li>
            <li><a href="Classement.html">üèÜ Classement</a></li>
            <li><a href="Profil.html">üë§ Profil</a></li>
            <li><a href="Contact.html">Contact</a></li>
        </ul>
    </nav>

    <main>
        <div class="breadcrumb" id="breadcrumb"></div>

        <div class="quiz-header" id="quiz-header">
            <h1 id="quiz-title">Chargement...</h1>
        </div>

        <div class="score-display" id="score-display">
            <p>Score : <span id="current-score">0</span> / <span id="total-questions">0</span></p>
        </div>

        <div id="quiz-container">
            <div class="loading">
                <div class="spinner"></div>
                <p>Chargement des questions...</p>
            </div>
        </div>

        <div id="global-timer" class="global-timer">
            <div>‚è±Ô∏è Temps</div>
            <div class="timer-value" id="timer-value">0:00</div>
        </div>
    </main>

    <!-- Modal R√©sultats -->
    <div id="results-modal" class="results-modal">
        <div class="results-content">
            <div class="results-header" id="results-emoji">üéâ</div>
            <div class="results-score" id="results-score">0/0</div>
            <div class="results-percentage" id="results-percentage">0%</div>

            <div class="xp-gain" id="xp-section">
                <div class="xp-gain-title">XP Gagn√©s</div>
                <div class="xp-gain-value" id="xp-gained">+0 XP</div>
            </div>

            <div class="level-up" id="level-up-section" style="display: none;">
                üéä Niveau sup√©rieur ! Niveau <span id="new-level">2</span>
            </div>

            <div class="new-badges" id="new-badges-section"></div>

            <div class="results-actions">
                <a href="Quiz.html" class="btn-result secondary">‚Üê Autre Quiz</a>
                <button class="btn-result primary" onclick="location.reload()">üîÑ Rejouer</button>
                <a href="Profil.html" class="btn-result secondary">üë§ Mon Profil</a>
            </div>
        </div>
    </div>

    <footer>
        <p>Copyright ¬© 2024 SuperQuiz. Tous droits r√©serv√©s.</p>
    </footer>

    <script src="js/script.js"></script>
    <script>
        // Param√®tres URL
        const urlParams = new URLSearchParams(window.location.search);
        const matiere = urlParams.get('matiere');
        const categorie = urlParams.get('categorie');
        const mode = urlParams.get('mode') || 'classic';

        let answeredQuestions = new Set();
        let currentScoare = 0;
        let quizStartTime = null;
        let timerInterval = null;

        // Initialisation
        window.addEventListener('load', () => {
            setTimeout(initQuiz, 100);
        });

        async function initQuiz() {
            if (typeof firebase === 'undefined') {
                setTimeout(initQuiz, 200);
                return;
            }

            if (!matiere || !categorie) {
                document.getElementById('quiz-container').innerHTML =
                    '<div class="error-message"><h2>Erreur</h2><p>Param√®tres de quiz manquants. <a href="Quiz.html" style="color: white;">Retour aux quiz</a></p></div>';
                return;
            }

            try {
                // Charger les questions depuis Firestore
                if (typeof firebase === 'undefined' || typeof db === 'undefined') {
                    throw new Error('Firebase non initialis√©');
                }

                const questionsSnapshot = await db.collection('questionBank')
                    .where('matiere', '==', matiere)
                    .where('categorie', '==', categorie)
                    .get();

                if (questionsSnapshot.empty) {
                    throw new Error(`Aucune question trouv√©e pour ${matiere} / ${categorie}.`);
                }

                const allQuestions = questionsSnapshot.docs.map(doc => {
                    const data = doc.data();
                    // Assurer la compatibilit√© entre "reponses" et "answers"
                    if (!data.reponses && data.answers) {
                        data.reponses = data.answers;
                    }
                    return data;
                });

                // Pour le titre, on va le construire dynamiquement
                const categorieNom = categorie.charAt(0).toUpperCase() + categorie.slice(1).replace('-', ' ');
                const titreQuiz = `Quiz de ${categorieNom}`;
                if (!allQuestions) {
                    throw new Error('Cat√©gorie introuvable');
                }

                const shuffledQuestions = [...allQuestions].sort(() => 0.5 - Math.random());
                const selectedQuestions = shuffledQuestions.slice(0, 10);

                // Titre avec badge de mode
                const modeBadge = mode === 'challenge'
                    ? '<span class="mode-badge challenge">üî• D√âFI</span>'
                    : '<span class="mode-badge classic">üéØ CLASSIQUE</span>';
                document.getElementById('quiz-title').innerHTML = titreQuiz + modeBadge;

                // Breadcrumb
                const matiereNom = matiere.charAt(0).toUpperCase() + matiere.slice(1);
                document.getElementById('breadcrumb').innerHTML =
                    `<a href="Quiz.html">Quiz</a> > <a href="${matiereNom}.html">${matiereNom}</a> > ${categorieNom}`;

                // Questions
                const container = document.getElementById('quiz-container');
                container.innerHTML = '';

                selectedQuestions.forEach((q, index) => {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'question-card';
                    questionDiv.innerHTML = `
                        <span class="question-number">Question ${index + 1}</span>
                        <div class="question-text">${q.question}</div>
                        ${q.reponses.map((rep, i) => `
                            <div class="answer-option" onclick="selectAnswer(${index}, ${i})">
                                <input type="radio" id="q${index}_r${i}" name="q${index}" value="${i}">
                                <label for="q${index}_r${i}">${rep}</label>
                            </div>
                        `).join('')}
                        <button class="btn-valider" onclick="validerQuestion(${index}, ${q.correct})">Valider</button>
                        <div id="feedback${index}" class="reponse-feedback"></div>
                    `;
                    container.appendChild(questionDiv);
                });

                document.getElementById('total-questions').textContent = selectedQuestions.length;

                // D√©marrer le timer en mode d√©fi
                if (mode === 'challenge') {
                    startTimer();
                }

                // Timer de d√©but
                quizStartTime = Date.now();

                // Menu auth
                initAuthMenu();

            } catch (error) {
                console.error(error);
                document.getElementById('quiz-container').innerHTML =
                    `<div class="error-message"><h2>Erreur de chargement</h2><p>${error.message}<br>
                    Note: La recherche par cat√©gorie peut n√©cessiter la cr√©ation d'un index dans Firebase. 
                    V√©rifiez la console du navigateur (F12) pour un lien de cr√©ation d'index.
                    <br><a href="Quiz.html" style="color: #3498db;">Retour aux quiz</a></p></div>`;
            }
        }

        function startTimer() {
            const timerElement = document.getElementById('global-timer');
            timerElement.classList.add('active');

            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - quizStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('timer-value').textContent =
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }, 100);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
        }

        function selectAnswer(qIndex, answerIndex) {
            const radio = document.getElementById(`q${qIndex}_r${answerIndex}`);
            if (radio && !radio.disabled) {
                radio.checked = true;
                document.querySelectorAll(`input[name="q${qIndex}"]`).forEach(r => {
                    r.closest('.answer-option').classList.remove('selected');
                });
                radio.closest('.answer-option').classList.add('selected');
            }
        }

        function validerQuestion(qIndex, correctAnswer) {
            const selected = document.querySelector(`input[name="q${qIndex}"]:checked`);
            const feedback = document.getElementById(`feedback${qIndex}`);

            if (!selected) {
                feedback.className = 'reponse-feedback incorrect';
                feedback.textContent = '‚ö†Ô∏è Veuillez s√©lectionner une r√©ponse';
                feedback.style.display = 'block';
                return;
            }

            if (answeredQuestions.has(qIndex)) return;

            const isCorrect = parseInt(selected.value) === correctAnswer;

            if (isCorrect) {
                currentScore++;
                document.getElementById('current-score').textContent = currentScore;
                feedback.className = 'reponse-feedback correct';
                feedback.textContent = '‚úÖ Bravo ! Bonne r√©ponse !';
            } else {
                feedback.className = 'reponse-feedback incorrect';
                const correctText = document.querySelector(`input[name="q${qIndex}"][value="${correctAnswer}"]`)
                    .nextElementSibling.textContent;
                feedback.textContent = '‚ùå Incorrect. La bonne r√©ponse √©tait : ' + correctText;
            }

            feedback.style.display = 'block';
            answeredQuestions.add(qIndex);

            // D√©sactiver les options
            document.querySelectorAll(`input[name="q${qIndex}"]`).forEach(r => {
                r.disabled = true;
                r.closest('.answer-option').style.opacity = '0.6';
                r.closest('.answer-option').style.cursor = 'not-allowed';
            });

            // Quiz termin√© ?
            const totalQuestions = parseInt(document.getElementById('total-questions').textContent);
            if (answeredQuestions.size === totalQuestions) {
                stopTimer();
                setTimeout(saveScore, 500);
            }
        }

        async function saveScore() {
            const score = currentScore;
            const total = parseInt(document.getElementById('total-questions').textContent);
            const quizTitle = document.getElementById('quiz-title').textContent.split('<')[0].trim();
            const tempsEnSecondes = Math.floor((Date.now() - quizStartTime) / 1000);

            // V√©rifier connexion
            if (typeof FirebaseAuth === 'undefined') {
                showResults(score, total, null);
                return;
            }

            const user = FirebaseAuth.getCurrentUser();
            if (!user) {
                showResults(score, total, null);
                return;
            }

            const scoreData = {
                matiere: matiere,
                categorie: categorie,
                titre: quizTitle,
                score: score,
                total: total,
                mode: mode,
                tempsEnSecondes: tempsEnSecondes
            };

            try {
                const result = await FirebaseScores.save(scoreData);
                showResults(score, total, result.profileUpdate);
            } catch (error) {
                console.error('Erreur sauvegarde:', error);
                showResults(score, total, null);
            }
        }

        function showResults(score, total, profileUpdate) {
            const percentage = Math.round((score / total) * 100);

            // Emoji selon le score
            let emoji = 'üòî';
            if (percentage >= 90) emoji = 'üèÜ';
            else if (percentage >= 70) emoji = 'üéâ';
            else if (percentage >= 50) emoji = 'üëç';
            else if (percentage >= 30) emoji = 'ü§î';

            document.getElementById('results-emoji').textContent = emoji;
            document.getElementById('results-score').textContent = `${score}/${total}`;
            document.getElementById('results-percentage').textContent = `${percentage}%`;

            // XP et badges
            if (profileUpdate) {
                document.getElementById('xp-gained').textContent = `+${profileUpdate.xpGagne} XP`;

                // Level up ?
                if (profileUpdate.levelUp) {
                    document.getElementById('new-level').textContent = profileUpdate.newNiveau;
                    document.getElementById('level-up-section').style.display = 'block';
                }

                // Nouveaux badges ?
                if (profileUpdate.nouveauxBadges && profileUpdate.nouveauxBadges.length > 0) {
                    const badgesHtml = profileUpdate.nouveauxBadges.map(badge =>
                        `<div class="badge-earned">${badge.icone} ${badge.nom}</div>`
                    ).join('');
                    document.getElementById('new-badges-section').innerHTML =
                        '<p style="margin-bottom: 10px;">üéñÔ∏è Nouveaux badges :</p>' + badgesHtml;
                }
            } else {
                document.getElementById('xp-section').innerHTML =
                    '<p style="color: #7f8c8d;">Connectez-vous pour gagner des XP !</p>';
            }

            // Afficher le modal
            document.getElementById('results-modal').classList.add('active');
        }

        function initAuthMenu() {
            if (typeof FirebaseAuth === 'undefined') return;

            FirebaseAuth.onAuthStateChanged(user => {
                const nav = document.querySelector('.menu');
                if (!nav) return;

                const existingAuthItem = document.getElementById('auth-menu-item');
                if (existingAuthItem) existingAuthItem.remove();

                const authItem = document.createElement('li');
                authItem.id = 'auth-menu-item';

                if (user) {
                    authItem.innerHTML = `
                        <a href="#" onclick="logout(event)" style="color: #2ecc71;">
                            üë§ ${user.displayName || user.email.split('@')[0]} <span style="font-size: 0.8em;">(D√©co)</span>
                        </a>
                    `;
                } else {
                    authItem.innerHTML = '<a href="Auth.html" style="color: #e74c3c;">üîê Connexion</a>';
                }

                nav.appendChild(authItem);
            });
        }

        async function logout(event) {
            event.preventDefault();
            if (confirm('Voulez-vous vraiment vous d√©connecter ?')) {
                try {
                    await FirebaseAuth.logout();
                    window.location.href = 'Accueil.html';
                } catch (error) {
                    alert('Erreur lors de la d√©connexion');
                }
            }
        }
    </script>
</body>

</html>