<!DOCTYPE html>
<html lang="fr">

<head>
    <link rel="icon" type="image/png" sizes="32x32" href="Images/favicon-32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="Images/favicon-16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="Images/logo-192.png">
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-G3YEKJLDRT"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());
        gtag('config', 'G-G3YEKJLDRT');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SuperQuiz - Quiz Dynamique</title>
    <link rel="stylesheet" href="css/style.css">

    <!-- Firebase SDK -->
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script defer src="firebase-config.js"></script>
    <script defer src="js/menu.js"></script>
    <script defer src="js/profile-system.js"></script>
    <script defer src="js/social-system.js"></script>
    <script defer src="js/streaks-system.js"></script>
    <script defer src="js/seasons-system.js"></script>
    <script defer src="js/clubs-system.js"></script>
    <script defer src="js/titles-system.js"></script>
    <script defer src="js/themes-system.js"></script>

    <style>
        .quiz-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 10px;
        }

        .quiz-header h1 {
            margin: 0;
            font-size: 2em;
        }

        .breadcrumb {
            margin: 20px 0;
            font-size: 0.9em;
        }

        .breadcrumb a {
            color: #3498db;
            text-decoration: none;
        }

        .score-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            font-size: 1.2em;
            font-weight: bold;
        }

        .score-display span {
            font-size: 1.3em;
            color: #ffd700;
        }

        .question-card {
            background: white;
            border: 2px solid #3498db;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .question-number {
            background: #3498db;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .question-text {
            font-size: 1.2em;
            margin: 20px 0;
            color: #2c3e50;
            font-weight: 500;
        }

        .answer-option {
            display: flex;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .answer-option:hover {
            background: #e8f4fd;
            border-color: #3498db;
        }

        .answer-option.selected {
            background: #e8f4fd;
            border-color: #3498db;
        }

        .answer-option input[type="radio"] {
            margin-right: 15px;
            transform: scale(1.3);
        }

        .answer-option label {
            cursor: pointer;
            flex: 1;
            font-size: 1em;
        }

        .btn-valider {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: transform 0.2s;
        }

        .btn-valider:hover {
            transform: scale(1.05);
        }

        .reponse-feedback {
            display: none;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-weight: bold;
        }

        .reponse-feedback.correct {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .reponse-feedback.incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .answer-option.correct-answer {
            background: #d4edda !important;
            border-color: #28a745 !important;
        }

        .answer-option.wrong-answer {
            background: #f8d7da !important;
            border-color: #dc3545 !important;
        }

        .global-timer {
            position: fixed;
            top: 100px;
            right: 20px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 3px 15px rgba(0, 0, 0, 0.2);
            z-index: 100;
            display: none;
        }

        .global-timer.active {
            display: block;
        }

        .timer-value {
            font-size: 1.5em;
            font-weight: bold;
        }

        .mode-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .mode-badge.classic {
            background: #3498db;
        }

        .mode-badge.challenge {
            background: #e74c3c;
        }

        .mode-badge.revision {
            background: #9b59b6;
        }

        .difficulty-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        .difficulty-badge.facile {
            background: #2ecc71;
        }

        .difficulty-badge.moyen {
            background: #f39c12;
        }

        .difficulty-badge.difficile {
            background: #e74c3c;
        }

        .error-message {
            text-align: center;
            padding: 50px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .error-message h2 {
            color: #e74c3c;
        }

        /* Modal R√©sultats */
        .results-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .results-modal.active {
            display: flex;
        }

        .results-content {
            background: white;
            border-radius: 15px;
            padding: 25px 20px;
            text-align: center;
            max-width: 360px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            animation: popIn 0.3s ease;
        }

        @keyframes popIn {
            from {
                transform: scale(0.8);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .results-header {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .results-score {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
        }

        .results-percentage {
            font-size: 1.1em;
            color: #7f8c8d;
            margin-bottom: 12px;
        }

        .xp-gain {
            background: linear-gradient(135deg, #f1c40f, #f39c12);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            margin: 12px 0;
        }

        .xp-gain-title {
            font-size: 0.8em;
            opacity: 0.9;
        }

        .xp-gain-value {
            font-size: 1.4em;
            font-weight: bold;
        }

        .level-up {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: bold;
            font-size: 0.9em;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        .new-badges {
            margin: 10px 0;
        }

        .badge-earned {
            display: inline-block;
            background: #f8f9fa;
            padding: 6px 10px;
            border-radius: 8px;
            margin: 3px;
            border: 2px solid #f1c40f;
            font-size: 0.85em;
        }

        .results-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .btn-result {
            padding: 10px 16px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9em;
            border: none;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-result:hover {
            transform: scale(1.05);
        }

        .btn-result.primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-result.secondary {
            background: #ecf0f1;
            color: #2c3e50;
        }

        /* Styles pour les fiches culture */
        .culture-card-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .culture-card-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .culture-card-content {
            position: relative;
            background: white;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.8);
            opacity: 0;
            transition: all 0.3s ease;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .culture-card-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .culture-card-header h3 {
            margin: 0;
            font-size: 1.4em;
        }

        .culture-card-close {
            cursor: pointer;
            font-size: 1.5em;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.3s ease;
        }

        .culture-card-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .culture-card-body {
            padding: 25px;
        }

        .culture-card-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .culture-card-text {
            line-height: 1.6;
            color: #555;
            margin-bottom: 20px;
            font-size: 1.05em;
        }

        .culture-card-sources {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            font-size: 0.9em;
            color: #666;
        }

        .culture-card-actions {
            padding: 20px 25px;
            background: #f8f9fa;
            border-radius: 0 0 15px 15px;
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .culture-card-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-favorite {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .btn-favorite:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.3);
        }

        .btn-close {
            background: #6c757d;
            color: white;
        }

        .btn-close:hover {
            background: #5a6268;
        }

        @media (max-width: 768px) {
            .culture-card-content {
                width: 95%;
                max-height: 90vh;
            }

            .culture-card-actions {
                flex-direction: column;
            }

            .culture-card-actions button {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <main>
        <div class="breadcrumb" id="breadcrumb"></div>

        <div class="quiz-header" id="quiz-header">
            <h1 id="quiz-title">Chargement...</h1>
        </div>

        <div class="score-display" id="score-display">
            <p>Score : <span id="current-score">0</span> / <span id="total-questions">0</span></p>
        </div>

        <div id="quiz-container">
            <div class="loading">
                <div class="spinner"></div>
                <p>Chargement des questions...</p>
            </div>
        </div>

        <div id="global-timer" class="global-timer">
            <div>‚è±Ô∏è Temps</div>
            <div class="timer-value" id="timer-value">0:00</div>
        </div>
    </main>

    <!-- Modal R√©sultats -->
    <div id="results-modal" class="results-modal">
        <div class="results-content">
            <div class="results-header" id="results-emoji">üéâ</div>
            <div class="results-score" id="results-score">0/0</div>
            <div class="results-percentage" id="results-percentage">0%</div>

            <div class="xp-gain" id="xp-section">
                <div class="xp-gain-title">XP Gagn√©s</div>
                <div class="xp-gain-value" id="xp-gained">+0 XP</div>
            </div>

            <div class="level-up" id="level-up-section" style="display: none;">
                üéä Niveau <span id="new-level">2</span> atteint !
            </div>

            <!-- Section streak -->
            <div id="streak-section" style="display: none; margin: 10px 0; padding: 10px; background: linear-gradient(135deg, #ff6b35, #f7931e); border-radius: 8px; color: white;">
                <div style="font-size: 1.3em; display: inline;" id="streak-flame">üî•</div>
                <span style="font-weight: bold; font-size: 0.9em;" id="streak-count">S√©rie de X jours !</span>
                <div style="font-size: 0.8em; opacity: 0.9;" id="streak-bonus"></div>
            </div>

            <!-- Section saison -->
            <div id="season-section" style="display: none; margin: 10px 0; padding: 8px 12px; background: var(--bg-secondary, #f8f9fa); border-radius: 8px;">
                <div id="season-points" style="font-weight: bold; font-size: 0.9em;"></div>
            </div>

            <div class="new-badges" id="new-badges-section"></div>

            <!-- Section partage et d√©fis -->
            <div class="share-section" id="share-section" style="margin: 12px 0; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                <p style="margin: 0 0 8px 0; font-weight: 600; color: #2c3e50; font-size: 0.85em;">üì§ Partager</p>
                <div style="display: flex; gap: 6px; flex-wrap: wrap; justify-content: center;">
                    <button onclick="shareResult('twitter')" style="padding: 6px 10px; border: none; border-radius: 6px; background: #1DA1F2; color: white; cursor: pointer; font-size: 0.8em;">üê¶</button>
                    <button onclick="shareResult('facebook')" style="padding: 6px 10px; border: none; border-radius: 6px; background: #4267B2; color: white; cursor: pointer; font-size: 0.8em;">üìò</button>
                    <button onclick="shareResult('whatsapp')" style="padding: 6px 10px; border: none; border-radius: 6px; background: #25D366; color: white; cursor: pointer; font-size: 0.8em;">üí¨</button>
                    <button onclick="shareResult('copy')" style="padding: 6px 10px; border: none; border-radius: 6px; background: #95a5a6; color: white; cursor: pointer; font-size: 0.8em;">üìã</button>
                </div>
            </div>

            <!-- Bouton d√©fier un ami -->
            <div id="challenge-friend-section" style="margin: 10px 0; display: none;">
                <button onclick="openChallengeModal()" style="padding: 8px 16px; border: none; border-radius: 8px; background: linear-gradient(135deg, #f39c12 0%, #e74c3c 100%); color: white; cursor: pointer; font-weight: 600; font-size: 0.9em;">‚öîÔ∏è D√©fier un ami</button>
            </div>

            <div class="results-actions" id="results-actions">
                <a href="Quiz.html" class="btn-result secondary">‚Üê Autre Quiz</a>
                <button class="btn-result primary" onclick="location.reload()">üîÑ Rejouer</button>
                <a href="Profil.html" class="btn-result secondary">üë§ Mon Profil</a>
            </div>
        </div>
    </div>

    <footer>
        <p>Copyright ¬© 2024 SuperQuiz. Tous droits r√©serv√©s.</p>
    </footer>

    <script src="js/script.js"></script>
    <script>
        // Param√®tres URL
        const urlParams = new URLSearchParams(window.location.search);
        const matiere = urlParams.get('matiere');
        const categorie = urlParams.get('categorie');
        const mode = urlParams.get('mode') || 'classic';
        const difficulty = urlParams.get('difficulty') || null; // null = toutes difficult√©s

        let answeredQuestions = new Set();
        let currentScore = 0;
        let quizStartTime = null;
        let timerInterval = null;
        let isRevisionMode = mode === 'revision' || sessionStorage.getItem('revisionMode') === 'true';
        let revisionQuestionIds = [];
        let revisionQuestionsData = []; // Pour stocker les donn√©es des questions en r√©vision

        // Variables pour l'affichage question par question
        window.currentQuestionIndex = 0;
        window.allSelectedQuestions = [];
        window.shuffledAnswersData = [];

        // Initialisation
        window.addEventListener('load', () => {
            setTimeout(initQuiz, 100);
        });

        async function initQuiz() {
            if (typeof firebase === 'undefined') {
                setTimeout(initQuiz, 200);
                return;
            }

            // Mode r√©vision
            if (isRevisionMode) {
                await initRevisionQuiz();
                return;
            }

            if (!matiere || !categorie) {
                document.getElementById('quiz-container').innerHTML =
                    '<div class="error-message"><h2>Erreur</h2><p>Param√®tres de quiz manquants. <a href="Quiz.html" style="color: white;">Retour aux quiz</a></p></div>';
                return;
            }

            try {
                // Charger les questions depuis Firestore
                if (typeof firebase === 'undefined' || typeof db === 'undefined') {
                    throw new Error('Firebase non initialis√©');
                }

                // Construire la requ√™te avec ou sans filtre de difficult√©
                let query = db.collection('questionBank')
                    .where('matiere', '==', matiere)
                    .where('categorie', '==', categorie);

                // Ajouter le filtre de difficult√© si sp√©cifi√©
                if (difficulty) {
                    query = query.where('difficulty', '==', difficulty);
                }

                const questionsSnapshot = await query.get();

                if (questionsSnapshot.empty) {
                    const difficultyText = difficulty ? ` en difficult√© "${difficulty}"` : '';
                    throw new Error(`Aucune question trouv√©e pour ${matiere} / ${categorie}${difficultyText}.`);
                }

                const allQuestions = questionsSnapshot.docs.map(doc => {
                    const data = doc.data();
                    // Assurer la compatibilit√© entre "reponses" et "answers"
                    if (!data.reponses && data.answers) {
                        data.reponses = data.answers;
                    }
                    return data;
                });

                // Pour le titre, on va le construire dynamiquement
                const categorieNom = categorie.charAt(0).toUpperCase() + categorie.slice(1).replace('-', ' ');
                const titreQuiz = `Quiz de ${categorieNom}`;
                if (!allQuestions) {
                    throw new Error('Cat√©gorie introuvable');
                }

                const shuffledQuestions = [...allQuestions].sort(() => 0.5 - Math.random());
                const selectedQuestions = shuffledQuestions.slice(0, 10);

                // Titre avec badge de mode et difficult√©
                const modeBadge = mode === 'challenge'
                    ? '<span class="mode-badge challenge">üî• D√âFI</span>'
                    : '<span class="mode-badge classic">üéØ CLASSIQUE</span>';

                // Badge de difficult√©
                let difficultyBadge = '';
                if (difficulty) {
                    const difficultyEmojis = { facile: 'üü¢', moyen: 'üü°', difficile: 'üî¥' };
                    const difficultyNames = { facile: 'Facile', moyen: 'Moyen', difficile: 'Difficile' };
                    difficultyBadge = `<span class="difficulty-badge ${difficulty}">${difficultyEmojis[difficulty]} ${difficultyNames[difficulty]}</span>`;
                }

                document.getElementById('quiz-title').innerHTML = titreQuiz + modeBadge + difficultyBadge;

                // Breadcrumb
                const matiereNom = matiere.charAt(0).toUpperCase() + matiere.slice(1);
                document.getElementById('breadcrumb').innerHTML =
                    `<a href="Quiz.html">Quiz</a> > <a href="${matiereNom}.html">${matiereNom}</a> > ${categorieNom}`;

                // Stocker les questions pour l'affichage une par une
                window.allSelectedQuestions = selectedQuestions;
                window.correctAnswersMap = [];
                window.shuffledAnswersData = [];
                window.currentQuestionIndex = 0;

                // Pr√©parer les r√©ponses m√©lang√©es pour toutes les questions
                selectedQuestions.forEach((q, index) => {
                    const shuffledAnswers = q.reponses.map((rep, i) => ({ text: rep, originalIndex: i }));
                    for (let i = shuffledAnswers.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [shuffledAnswers[i], shuffledAnswers[j]] = [shuffledAnswers[j], shuffledAnswers[i]];
                    }
                    const newCorrectIndex = shuffledAnswers.findIndex(a => a.originalIndex === q.correct);
                    window.correctAnswersMap[index] = newCorrectIndex;
                    window.shuffledAnswersData[index] = shuffledAnswers;
                });

                document.getElementById('total-questions').textContent = selectedQuestions.length;

                // Afficher la premi√®re question
                displayCurrentQuestion();

                // D√©marrer le timer en mode d√©fi
                if (mode === 'challenge') {
                    startTimer();
                }

                // Timer de d√©but
                quizStartTime = Date.now();

            } catch (error) {
                console.error(error);
                document.getElementById('quiz-container').innerHTML =
                    `<div class="error-message"><h2>Erreur de chargement</h2><p>${error.message}<br>
                    Note: La recherche par cat√©gorie peut n√©cessiter la cr√©ation d'un index dans Firebase.
                    V√©rifiez la console du navigateur (F12) pour un lien de cr√©ation d'index.
                    <br><a href="Quiz.html" style="color: #3498db;">Retour aux quiz</a></p></div>`;
            }
        }

        // ========== MODE R√âVISION ==========
        async function initRevisionQuiz() {
            const user = firebase.auth().currentUser;

            if (!user) {
                // Attendre l'authentification
                firebase.auth().onAuthStateChanged(async (authUser) => {
                    if (authUser) {
                        await loadRevisionQuestions(authUser.uid);
                    } else {
                        document.getElementById('quiz-container').innerHTML =
                            '<div class="error-message"><h2>Connexion requise</h2><p>Connectez-vous pour acc√©der au mode r√©vision.<br><a href="Auth.html?redirect=revision.html" style="color: #3498db;">Se connecter</a></p></div>';
                    }
                });
                return;
            }

            await loadRevisionQuestions(user.uid);
        }

        async function loadRevisionQuestions(userId) {
            try {
                // R√©cup√©rer les IDs des questions √† r√©viser depuis sessionStorage
                const storedIds = sessionStorage.getItem('revisionQuestionIds');

                let questionsToLoad = [];

                if (storedIds) {
                    revisionQuestionIds = JSON.parse(storedIds);

                    // Charger les questions sp√©cifiques
                    for (const qId of revisionQuestionIds) {
                        const docRef = db.collection('profiles').doc(userId)
                            .collection('missedQuestions').doc(qId);
                        const doc = await docRef.get();

                        if (doc.exists) {
                            questionsToLoad.push({
                                id: doc.id,
                                ...doc.data()
                            });
                        }
                    }
                } else {
                    // Si pas d'IDs sp√©cifi√©s, charger toutes les questions non ma√Ætris√©es
                    const snapshot = await db.collection('profiles').doc(userId)
                        .collection('missedQuestions')
                        .where('masteredAt', '==', null)
                        .limit(10)
                        .get();

                    // Si la requ√™te avec where ne fonctionne pas, essayer sans
                    if (snapshot.empty) {
                        const allSnapshot = await db.collection('profiles').doc(userId)
                            .collection('missedQuestions')
                            .limit(20)
                            .get();

                        allSnapshot.forEach(doc => {
                            const data = doc.data();
                            if (!data.masteredAt) {
                                questionsToLoad.push({
                                    id: doc.id,
                                    ...data
                                });
                            }
                        });

                        // Limiter √† 10 questions
                        questionsToLoad = questionsToLoad.slice(0, 10);
                    } else {
                        snapshot.forEach(doc => {
                            questionsToLoad.push({
                                id: doc.id,
                                ...doc.data()
                            });
                        });
                    }
                }

                // Nettoyer le sessionStorage
                sessionStorage.removeItem('revisionQuestionIds');
                sessionStorage.removeItem('revisionMode');

                if (questionsToLoad.length === 0) {
                    document.getElementById('quiz-container').innerHTML =
                        `<div class="error-message">
                            <h2>üéâ Bravo !</h2>
                            <p>Tu n'as aucune question √† r√©viser pour le moment.<br>
                            Continue √† jouer pour enrichir ta liste de r√©vision !</p>
                            <a href="Quiz.html" style="color: #3498db; display: inline-block; margin-top: 15px;">Jouer un quiz</a>
                        </div>`;
                    return;
                }

                // Stocker les donn√©es pour la mise √† jour apr√®s r√©ponse
                revisionQuestionsData = questionsToLoad;

                // M√©langer les questions
                const shuffledQuestions = [...questionsToLoad].sort(() => 0.5 - Math.random());

                // Afficher le titre
                document.getElementById('quiz-title').innerHTML =
                    `üìö Quiz de R√©vision <span class="mode-badge revision">üîÑ R√âVISION</span>`;

                // Breadcrumb
                document.getElementById('breadcrumb').innerHTML =
                    `<a href="Quiz.html">Quiz</a> > <a href="revision.html">R√©vision</a> > Quiz de r√©vision`;

                // Stocker les questions pour l'affichage une par une
                window.allSelectedQuestions = shuffledQuestions;
                window.correctAnswersMap = [];
                window.shuffledAnswersData = [];
                window.revisionQuestionIdsMap = [];
                window.currentQuestionIndex = 0;

                // Pr√©parer les r√©ponses m√©lang√©es pour toutes les questions
                shuffledQuestions.forEach((q, index) => {
                    const reponses = q.reponses || [];
                    const correctIndex = q.correctIndex || 0;

                    const shuffledAnswers = reponses.map((rep, i) => ({ text: rep, originalIndex: i }));
                    for (let i = shuffledAnswers.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [shuffledAnswers[i], shuffledAnswers[j]] = [shuffledAnswers[j], shuffledAnswers[i]];
                    }

                    const newCorrectIndex = shuffledAnswers.findIndex(a => a.originalIndex === correctIndex);
                    window.correctAnswersMap[index] = newCorrectIndex;
                    window.shuffledAnswersData[index] = shuffledAnswers;
                    window.revisionQuestionIdsMap[index] = q.id;
                });

                document.getElementById('total-questions').textContent = shuffledQuestions.length;
                quizStartTime = Date.now();

                // Afficher la premi√®re question
                displayCurrentQuestionRevision();

            } catch (error) {
                console.error('Erreur chargement r√©vision:', error);
                document.getElementById('quiz-container').innerHTML =
                    `<div class="error-message"><h2>Erreur de chargement</h2><p>${error.message}<br>
                    <a href="revision.html" style="color: #3498db;">Retour aux r√©visions</a></p></div>`;
            }
        }

        // Marquer une question comme ma√Ætris√©e apr√®s bonne r√©ponse en mode r√©vision
        async function markQuestionAsMastered(questionId) {
            const user = firebase.auth().currentUser;
            if (!user || !questionId) return;

            try {
                await db.collection('profiles').doc(user.uid)
                    .collection('missedQuestions').doc(questionId)
                    .update({
                        masteredAt: firebase.firestore.FieldValue.serverTimestamp(),
                        attempts: firebase.firestore.FieldValue.increment(1)
                    });
                console.log('‚úÖ Question marqu√©e comme ma√Ætris√©e:', questionId);
            } catch (error) {
                console.error('Erreur marquage ma√Ætris√©:', error);
            }
        }

        // Incr√©menter les tentatives apr√®s mauvaise r√©ponse en mode r√©vision
        async function incrementQuestionAttempts(questionId) {
            const user = firebase.auth().currentUser;
            if (!user || !questionId) return;

            try {
                await db.collection('profiles').doc(user.uid)
                    .collection('missedQuestions').doc(questionId)
                    .update({
                        attempts: firebase.firestore.FieldValue.increment(1),
                        lastMissedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
            } catch (error) {
                console.error('Erreur incr√©mentation tentatives:', error);
            }
        }

        function startTimer() {
            const timerElement = document.getElementById('global-timer');
            timerElement.classList.add('active');

            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - quizStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                document.getElementById('timer-value').textContent =
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }, 100);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
        }

        // Afficher la question actuelle
        function displayCurrentQuestion() {
            const container = document.getElementById('quiz-container');
            const index = window.currentQuestionIndex;
            const q = window.allSelectedQuestions[index];
            const shuffledAnswers = window.shuffledAnswersData[index];

            container.innerHTML = `
                <div class="question-card" style="animation: fadeInUp 0.4s ease-out;">
                    <span class="question-number">Question ${index + 1}/${window.allSelectedQuestions.length}</span>
                    <div class="question-text">${q.question}</div>
                    ${shuffledAnswers.map((ans, i) => `
                        <div class="answer-option" onclick="validateAnswer(${index}, ${i})" data-qindex="${index}" data-aindex="${i}">
                            ${ans.text}
                        </div>
                    `).join('')}
                    <div id="feedback${index}" class="reponse-feedback"></div>
                </div>
            `;
        }

        // Afficher la question actuelle en mode r√©vision
        function displayCurrentQuestionRevision() {
            const container = document.getElementById('quiz-container');
            const index = window.currentQuestionIndex;
            const q = window.allSelectedQuestions[index];
            const shuffledAnswers = window.shuffledAnswersData[index];

            container.innerHTML = `
                <div class="question-card" style="animation: fadeInUp 0.4s ease-out;">
                    <span class="question-number">Question ${index + 1}/${window.allSelectedQuestions.length}</span>
                    <div class="question-meta" style="margin: 10px 0; font-size: 0.85em;">
                        <span style="background: #f8f9fa; padding: 4px 10px; border-radius: 20px;">üìö ${q.matiere || 'G√©n√©ral'}</span>
                        <span style="background: #f8f9fa; padding: 4px 10px; border-radius: 20px;">‚ùå ${q.missCount || 1} erreur(s)</span>
                    </div>
                    <div class="question-text">${q.question}</div>
                    ${shuffledAnswers.map((ans, i) => `
                        <div class="answer-option" onclick="validateAnswer(${index}, ${i})" data-qindex="${index}" data-aindex="${i}">
                            ${ans.text}
                        </div>
                    `).join('')}
                    <div id="feedback${index}" class="reponse-feedback"></div>
                </div>
            `;
        }

        // Passer √† la question suivante
        function nextQuestion() {
            window.currentQuestionIndex++;
            const totalQuestions = window.allSelectedQuestions.length;

            if (window.currentQuestionIndex >= totalQuestions) {
                stopTimer();
                saveScore();
            } else {
                document.getElementById('current-score').textContent = currentScore;
                if (isRevisionMode) {
                    displayCurrentQuestionRevision();
                } else {
                    displayCurrentQuestion();
                }
            }
        }

        function validateAnswer(qIndex, answerIndex) {
            // V√©rifier si d√©j√† r√©pondu
            if (answeredQuestions.has(qIndex)) return;
            
            const selectedOption = document.querySelector(`.answer-option[data-qindex="${qIndex}"][data-aindex="${answerIndex}"]`);
            if (!selectedOption) return;
            
            // S√©lectionner visuellement
            document.querySelectorAll(`.answer-option[data-qindex="${qIndex}"]`).forEach(opt => {
                opt.classList.remove('selected');
            });
            selectedOption.classList.add('selected');
            
            // Valider imm√©diatement
            const feedback = document.getElementById(`feedback${qIndex}`);
            const correctAnswer = window.correctAnswersMap[qIndex];
            const isCorrect = answerIndex === correctAnswer;

            if (isCorrect) {
                currentScore++;
                document.getElementById('current-score').textContent = currentScore;
                feedback.className = 'reponse-feedback correct';
                feedback.textContent = '‚úÖ Bravo ! Bonne r√©ponse !';
                selectedOption.classList.add('correct-answer');

                // En mode r√©vision, marquer comme ma√Ætris√©
                if (isRevisionMode && window.revisionQuestionIdsMap && window.revisionQuestionIdsMap[qIndex]) {
                    markQuestionAsMastered(window.revisionQuestionIdsMap[qIndex]);
                    feedback.textContent = '‚úÖ Bravo ! Question ma√Ætris√©e !';
                }
            } else {
                feedback.className = 'reponse-feedback incorrect';
                const correctOption = document.querySelector(`.answer-option[data-qindex="${qIndex}"][data-aindex="${correctAnswer}"]`);
                feedback.textContent = '‚ùå Incorrect. La bonne r√©ponse √©tait : ' + correctOption.textContent.trim();
                selectedOption.classList.add('wrong-answer');
                // Montrer la bonne r√©ponse
                correctOption.classList.add('correct-answer');

                // En mode r√©vision, incr√©menter les tentatives
                if (isRevisionMode && window.revisionQuestionIdsMap && window.revisionQuestionIdsMap[qIndex]) {
                    incrementQuestionAttempts(window.revisionQuestionIdsMap[qIndex]);
                }
            }

            feedback.style.display = 'block';
            answeredQuestions.add(qIndex);

            // D√©sactiver les options
            document.querySelectorAll(`.answer-option[data-qindex="${qIndex}"]`).forEach(opt => {
                opt.style.pointerEvents = 'none';
                opt.style.cursor = 'not-allowed';
            });

            // Passer automatiquement √† la question suivante
            setTimeout(() => {
                nextQuestion();
            }, isCorrect ? 1000 : 1500);
        }

        // Afficher une fiche culture apr√®s une bonne r√©ponse
        async function showCultureCard(qIndex) {
            if (typeof CultureCardsSystem === 'undefined') return;

            try {
                // G√©n√©rer un ID unique pour la question
                const questionCard = document.querySelectorAll('.question-card')[qIndex];
                const questionText = questionCard.querySelector('.question-text').textContent;
                const questionId = `${matiere}_${categorie}_${btoa(questionText).substring(0, 20)}`;

                // Chercher une fiche pour cette question
                const card = await CultureCardsSystem.getCardForQuestion(questionId);

                if (card) {
                    // Cr√©er une modale pour afficher la fiche
                    const modal = document.createElement('div');
                    modal.className = 'culture-card-modal';
                    modal.innerHTML = `
                        <div class="culture-card-overlay" onclick="this.parentElement.remove()"></div>
                        <div class="culture-card-content">
                            <div class="culture-card-header">
                                <span class="culture-card-close" onclick="this.closest('.culture-card-modal').remove()">‚úï</span>
                                <h3>üìö Fiche Culture</h3>
                            </div>
                            <div class="culture-card-body">
                                <div class="culture-card-title">${card.titre || 'Fiche Culture'}</div>
                                <div class="culture-card-text">${card.contenu || card.description || 'Contenu non disponible'}</div>
                                ${card.sources ? `<div class="culture-card-sources"><strong>Sources:</strong> ${card.sources}</div>` : ''}
                            </div>
                            <div class="culture-card-actions">
                                <button class="btn-favorite" onclick="toggleCultureCardFavorite('${questionId}', this)">
                                    ${await isCultureCardFavorite(questionId) ? '‚úÖ En favoris' : '‚≠ê Ajouter aux favoris'}
                                </button>
                                <button class="btn-close" onclick="this.closest('.culture-card-modal').remove()">Fermer</button>
                            </div>
                        </div>
                    `;

                    document.body.appendChild(modal);

                    // Animation d'entr√©e
                    setTimeout(() => {
                        modal.querySelector('.culture-card-content').style.transform = 'scale(1)';
                        modal.querySelector('.culture-card-content').style.opacity = '1';
                    }, 10);
                }
            } catch (error) {
                console.error('Erreur affichage fiche culture:', error);
            }
        }

        // V√©rifier si une fiche est en favoris
        async function isCultureCardFavorite(questionId) {
            if (typeof firebase === 'undefined' || !firebase.auth) return false;

            const user = firebase.auth().currentUser;
            if (!user) return false;

            try {
                const favoriteRef = db.collection('profiles').doc(user.uid)
                    .collection('cultureCardFavorites').doc(questionId);
                const doc = await favoriteRef.get();
                return doc.exists;
            } catch (error) {
                console.error('Erreur v√©rification favoris:', error);
                return false;
            }
        }

        // Basculer l'√©tat favoris d'une fiche culture
        async function toggleCultureCardFavorite(questionId, buttonElement) {
            if (typeof firebase === 'undefined' || !firebase.auth) {
                alert('Connexion requise pour g√©rer les favoris');
                return;
            }

            const user = firebase.auth().currentUser;
            if (!user) {
                alert('Connexion requise pour g√©rer les favoris');
                return;
            }

            try {
                const isFavorite = await isCultureCardFavorite(questionId);

                if (isFavorite) {
                    await CultureCardsSystem.removeFromFavorites(user.uid, questionId);
                    buttonElement.textContent = '‚≠ê Ajouter aux favoris';
                } else {
                    await CultureCardsSystem.saveToFavorites(user.uid, questionId);
                    buttonElement.textContent = '‚úÖ En favoris';
                }
            } catch (error) {
                console.error('Erreur gestion favoris:', error);
                alert('Erreur lors de la gestion des favoris');
            }
        }

        async function saveScore() {
            const score = currentScore;
            const total = parseInt(document.getElementById('total-questions').textContent);
            const quizTitle = document.getElementById('quiz-title').textContent.split('<')[0].trim();
            const tempsEnSecondes = Math.floor((Date.now() - quizStartTime) / 1000);
            const isPerfect = score === total;

            // V√©rifier connexion
            if (typeof firebase === 'undefined' || !firebase.auth) {
                showResults(score, total, null);
                return;
            }

            const user = firebase.auth().currentUser;
            if (!user) {
                showResults(score, total, null);
                return;
            }

            // En mode r√©vision, on ne sauvegarde pas le score normalement
            if (isRevisionMode) {
                // Calculer un bonus XP pour la r√©vision
                const revisionXP = score * 5; // 5 XP par bonne r√©ponse en r√©vision

                try {
                    // Mettre √† jour le profil avec les XP de r√©vision
                    if (typeof ProfileSystem !== 'undefined') {
                        await db.collection('profiles').doc(user.uid).update({
                            experiencePoints: firebase.firestore.FieldValue.increment(revisionXP)
                        });
                    }

                    showResults(score, total, { xpGagne: revisionXP });
                } catch (error) {
                    console.error('Erreur sauvegarde r√©vision:', error);
                    showResults(score, total, { xpGagne: revisionXP });
                }
                return;
            }

            const scoreData = {
                matiere: matiere,
                categorie: categorie,
                titre: quizTitle,
                score: score,
                total: total,
                mode: mode,
                tempsEnSecondes: tempsEnSecondes
            };

            try {
                const result = await FirebaseScores.save(scoreData);
                
                // Mettre √† jour la s√©rie (streak)
                if (typeof StreaksSystem !== 'undefined') {
                    await StreaksSystem.recordActivity(user.uid);
                }

                // Ajouter des points de saison
                if (typeof SeasonsSystem !== 'undefined') {
                    const seasonPoints = score * 10 + (isPerfect ? 50 : 0);
                    await SeasonsSystem.addSeasonPoints(user.uid, seasonPoints, isPerfect);
                }

                // Ajouter des XP au club
                if (typeof ClubsSystem !== 'undefined') {
                    const xpForClub = result.profileUpdate?.xpGagne || score * 10;
                    await ClubsSystem.addClubXP(user.uid, xpForClub, {
                        isPerfect,
                        totalQuestions: total,
                        correctAnswers: score
                    });
                }

                // V√©rifier les nouveaux titres
                if (typeof TitlesSystem !== 'undefined') {
                    await TitlesSystem.checkUnlockedTitles(user.uid);
                }

                // R√©soudre un pari si actif
                const activeBet = sessionStorage.getItem('activeBet');
                if (activeBet && typeof BettingSystem !== 'undefined') {
                    const betInfo = JSON.parse(activeBet);
                    const betResult = await BettingSystem.resolveBet(betInfo.betId, {
                        correct: score,
                        total: total,
                        timeSeconds: tempsEnSecondes
                    });
                    sessionStorage.removeItem('activeBet');
                    if (betResult) {
                        result.betResult = betResult;
                    }
                }

                // Sauvegarder les questions rat√©es pour la r√©vision
                await saveMissedQuestions(user.uid, score, total);

                showResults(score, total, result.profileUpdate, result.betResult);
            } catch (error) {
                console.error('Erreur sauvegarde:', error);
                showResults(score, total, null);
            }
        }

        // Sauvegarder les questions rat√©es
        async function saveMissedQuestions(userId, score, total) {
            if (score === total) return; // Pas de questions rat√©es

            try {
                const questionCards = document.querySelectorAll('.question-card');
                
                for (let i = 0; i < questionCards.length; i++) {
                    const feedback = document.getElementById(`feedback${i}`);
                    if (feedback && feedback.classList.contains('incorrect')) {
                        const questionText = questionCards[i].querySelector('.question-text').textContent;
                        const questionId = `${matiere}_${categorie}_${btoa(questionText).substring(0, 20)}`;
                        
                        const missedRef = db.collection('profiles').doc(userId)
                            .collection('missedQuestions').doc(questionId);
                        
                        const existing = await missedRef.get();
                        
                        if (existing.exists) {
                            await missedRef.update({
                                missCount: firebase.firestore.FieldValue.increment(1),
                                lastMissedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        } else {
                            const answers = [];
                            questionCards[i].querySelectorAll('.answer-option').forEach(opt => {
                                answers.push(opt.textContent.trim());
                            });
                            
                            await missedRef.set({
                                question: questionText,
                                reponses: answers,
                                correctIndex: window.correctAnswersMap[i],
                                matiere: matiere,
                                categorie: categorie,
                                difficulty: difficulty || 'moyen',
                                missCount: 1,
                                attempts: 1,
                                lastMissedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        }
                    }
                }
            } catch (error) {
                console.error('Erreur sauvegarde questions rat√©es:', error);
            }
        }

        // Variables pour le partage
        let lastQuizScore = null;
        let lastQuizTotal = null;
        let lastQuizTime = null;

        function showResults(score, total, profileUpdate, betResult = null) {
            const percentage = Math.round((score / total) * 100);
            const elapsedTime = Math.floor((Date.now() - quizStartTime) / 1000);

            // Stocker pour le partage
            lastQuizScore = score;
            lastQuizTotal = total;
            lastQuizTime = elapsedTime;

            // Emoji selon le score
            let emoji = 'üòî';
            if (percentage >= 90) emoji = 'üèÜ';
            else if (percentage >= 70) emoji = 'üéâ';
            else if (percentage >= 50) emoji = 'üëç';
            else if (percentage >= 30) emoji = 'ü§î';

            document.getElementById('results-emoji').textContent = emoji;
            document.getElementById('results-score').textContent = `${score}/${total}`;
            document.getElementById('results-percentage').textContent = `${percentage}%`;

            // XP et badges
            if (profileUpdate) {
                // Message diff√©rent pour le mode r√©vision
                if (isRevisionMode) {
                    document.getElementById('xp-section').innerHTML = `
                        <div class="xp-gain-title">üîÑ XP R√©vision</div>
                        <div class="xp-gain-value">+${profileUpdate.xpGagne} XP</div>
                        <div style="font-size: 0.75em; margin-top: 3px; opacity: 0.9;">
                            ${score} question${score > 1 ? 's' : ''} ma√Ætris√©e${score > 1 ? 's' : ''} !
                        </div>
                    `;
                } else {
                    document.getElementById('xp-gained').textContent = `+${profileUpdate.xpGagne} XP`;
                }

                // Level up ?
                if (profileUpdate.levelUp) {
                    document.getElementById('new-level').textContent = profileUpdate.newNiveau;
                    document.getElementById('level-up-section').style.display = 'block';
                }

                // Nouveaux badges ?
                if (profileUpdate.nouveauxBadges && profileUpdate.nouveauxBadges.length > 0) {
                    const badgesHtml = profileUpdate.nouveauxBadges.map(badge =>
                        `<div class="badge-earned">${badge.icone} ${badge.nom}</div>`
                    ).join('');
                    document.getElementById('new-badges-section').innerHTML =
                        '<p style="margin-bottom: 10px;">üéñÔ∏è Nouveaux badges :</p>' + badgesHtml;
                }

                // Afficher la s√©rie (streak) - pas en mode r√©vision
                if (!isRevisionMode) {
                    showStreakInfo();
                    // Afficher les points de saison
                    showSeasonInfo(score);
                }
            } else {
                document.getElementById('xp-section').innerHTML =
                    '<p style="color: #7f8c8d;">Connectez-vous pour gagner des XP !</p>';
            }

            // R√©sultat du pari
            if (betResult) {
                const betSection = document.createElement('div');
                betSection.style.cssText = 'margin: 15px 0; padding: 15px; border-radius: 12px;';
                
                if (betResult.won) {
                    betSection.style.background = 'linear-gradient(135deg, #2ecc71, #27ae60)';
                    betSection.style.color = 'white';
                    betSection.innerHTML = `
                        <div style="font-size: 2em;">üé∞</div>
                        <div style="font-weight: bold;">Pari gagn√© !</div>
                        <div style="font-size: 1.3em;">+${betResult.winnings} XP</div>
                    `;
                } else {
                    betSection.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
                    betSection.style.color = 'white';
                    betSection.innerHTML = `
                        <div style="font-size: 2em;">üò¢</div>
                        <div style="font-weight: bold;">Pari perdu</div>
                        <div style="font-size: 0.9em;">Retente ta chance !</div>
                    `;
                }
                
                document.getElementById('xp-section').after(betSection);
            }

            // Afficher le modal
            document.getElementById('results-modal').classList.add('active');

            // Afficher le bouton de d√©fi si connect√© (sauf en mode r√©vision)
            if (firebase.auth().currentUser && !isRevisionMode) {
                document.getElementById('challenge-friend-section').style.display = 'block';
            }

            // Adapter les boutons pour le mode r√©vision
            if (isRevisionMode) {
                document.getElementById('results-actions').innerHTML = `
                    <a href="revision.html" class="btn-result secondary">‚Üê R√©visions</a>
                    <button class="btn-result primary" onclick="location.reload()">üîÑ Continuer</button>
                    <a href="Quiz.html" class="btn-result secondary">üéÆ Autre Quiz</a>
                `;

                // Cacher la section partage en mode r√©vision
                document.getElementById('share-section').style.display = 'none';
            }
        }

        // Afficher les infos de s√©rie
        async function showStreakInfo() {
            if (typeof StreaksSystem === 'undefined') return;
            
            const user = firebase.auth().currentUser;
            if (!user) return;

            try {
                const streakInfo = await StreaksSystem.getStreakInfo(user.uid);
                if (streakInfo && streakInfo.currentStreak > 0) {
                    const flameLevel = StreaksSystem.getFlameLevel(streakInfo.currentStreak);
                    const dailyBonus = StreaksSystem.getDailyBonus(streakInfo.currentStreak);
                    
                    document.getElementById('streak-section').style.display = 'block';
                    document.getElementById('streak-flame').textContent = flameLevel;
                    document.getElementById('streak-count').textContent = `S√©rie de ${streakInfo.currentStreak} jour${streakInfo.currentStreak > 1 ? 's' : ''} !`;
                    document.getElementById('streak-bonus').textContent = `+${dailyBonus} XP bonus quotidien`;
                }
            } catch (error) {
                console.error('Erreur streak info:', error);
            }
        }

        // Afficher les infos de saison
        async function showSeasonInfo(score) {
            if (typeof SeasonsSystem === 'undefined') return;
            
            const user = firebase.auth().currentUser;
            if (!user) return;

            try {
                const season = SeasonsSystem.getCurrentSeason();
                const seasonPoints = score * 10 + (score === parseInt(document.getElementById('total-questions').textContent) ? 50 : 0);
                
                document.getElementById('season-section').style.display = 'block';
                document.getElementById('season-points').innerHTML = `
                    ${season.emoji} <strong>Saison ${season.name}</strong> : +${seasonPoints} points
                `;
            } catch (error) {
                console.error('Erreur season info:', error);
            }
        }

        // Fonctions de partage
        async function shareResult(platform) {
            const scoreData = {
                score: lastQuizScore,
                total: lastQuizTotal,
                tempsEnSecondes: lastQuizTime,
                matiere: matiere,
                categorie: categorie,
                titre: document.getElementById('quiz-title').textContent
            };

            if (typeof SocialSystem !== 'undefined') {
                const result = await SocialSystem.shareResult(scoreData, platform);
                if (result && result.message) {
                    alert(result.message);
                }
            } else {
                // Fallback si SocialSystem n'est pas charg√©
                const text = `üéØ J'ai fait ${scoreData.score}/${scoreData.total} au quiz "${scoreData.titre}" sur SuperQuiz ! Peux-tu faire mieux ?`;
                const url = window.location.origin;
                
                if (platform === 'copy') {
                    await navigator.clipboard.writeText(text + ' ' + url);
                    alert('Lien copi√© !');
                } else if (platform === 'twitter') {
                    window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, '_blank');
                }
            }
        }

        // Modal de d√©fi
        function openChallengeModal() {
            // Rediriger vers la page sociale avec les infos du quiz
            sessionStorage.setItem('quizToChallenge', JSON.stringify({
                matiere: matiere,
                categorie: categorie,
                titre: document.getElementById('quiz-title').textContent,
                score: lastQuizScore,
                total: lastQuizTotal,
                tempsEnSecondes: lastQuizTime
            }));
            window.location.href = 'Social.html?action=challenge';
        }
    </script>
</body>

</html>