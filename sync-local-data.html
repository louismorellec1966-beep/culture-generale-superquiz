<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synchronisation Donn√©es Locales</title>
    <!-- Firebase SDK -->
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script defer src="firebase-config.js"></script>
</head>
<body>
    <h1>üîÑ Synchronisation Donn√©es Locales</h1>
    <button onclick="syncLocalData()">Synchroniser avec Firestore</button>
    <div id="status"></div>

    <script>
        async function syncLocalData() {
            const status = document.getElementById('status');
            status.textContent = 'üîÑ Synchronisation en cours...';

            try {
                // Attendre que Firebase soit pr√™t
                await new Promise(resolve => setTimeout(resolve, 2000));

                const user = firebase.auth().currentUser;
                if (!user) {
                    status.textContent = '‚ùå Vous devez √™tre connect√©';
                    status.style.color = 'red';
                    return;
                }

                const db = firebase.firestore();
                const userId = user.uid;

                // R√©cup√©rer les donn√©es locales
                const localSeasonData = JSON.parse(localStorage.getItem('localSeasonData') || '{}');

                if (Object.keys(localSeasonData).length === 0) {
                    status.textContent = '‚ÑπÔ∏è Aucune donn√©e locale √† synchroniser';
                    return;
                }

                status.textContent = 'üìä Synchronisation des donn√©es locales...\n';

                let syncedSeasons = 0;

                for (const [seasonId, data] of Object.entries(localSeasonData)) {
                    try {
                        const entryRef = db.collection('seasons')
                            .doc(seasonId)
                            .collection('entries')
                            .doc(userId);

                        // V√©rifier si l'entr√©e existe d√©j√†
                        const existingDoc = await entryRef.get();

                        if (existingDoc.exists) {
                            // Mettre √† jour en ajoutant les points locaux
                            await entryRef.update({
                                points: firebase.firestore.FieldValue.increment(data.points),
                                quizCompleted: firebase.firestore.FieldValue.increment(data.quizCompleted),
                                perfectQuiz: firebase.firestore.FieldValue.increment(data.perfectQuiz || 0),
                                lastActivity: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        } else {
                            // Cr√©er nouvelle entr√©e
                            await entryRef.set({
                                userId: userId,
                                points: data.points,
                                quizCompleted: data.quizCompleted,
                                perfectQuiz: data.perfectQuiz || 0,
                                joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                lastActivity: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        }

                        syncedSeasons++;
                        status.textContent += `‚úÖ Saison ${seasonId}: ${data.points} points synchronis√©s\n`;

                    } catch (error) {
                        status.textContent += `‚ùå Erreur saison ${seasonId}: ${error.message}\n`;
                    }
                }

                if (syncedSeasons > 0) {
                    // Vider les donn√©es locales apr√®s synchronisation
                    localStorage.removeItem('localSeasonData');
                    status.textContent += '\nüéâ Synchronisation termin√©e ! Donn√©es locales supprim√©es.';
                    status.style.color = 'green';
                } else {
                    status.textContent += '\n‚ö†Ô∏è Aucune synchronisation effectu√©e.';
                    status.style.color = 'orange';
                }

            } catch (error) {
                console.error('Erreur synchronisation:', error);
                status.textContent = '‚ùå Erreur: ' + error.message;
                status.style.color = 'red';
            }
        }
    </script>
</body>
</html>