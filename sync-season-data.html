<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synchronisation Donn√©es Saisons</title>
    <!-- Firebase SDK -->
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script defer src="firebase-config.js"></script>
</head>
<body>
    <h1>üîÑ Synchronisation Donn√©es Saisons</h1>
    <p>Cette page synchronise les donn√©es de saisons stock√©es localement avec Firestore.</p>

    <button onclick="syncSeasonData()">Synchroniser les donn√©es</button>
    <div id="status" style="margin-top: 20px; font-family: monospace; white-space: pre-line;"></div>

    <script>
        async function syncSeasonData() {
            const status = document.getElementById('status');
            status.textContent = 'üîÑ D√©marrage de la synchronisation...\n\n';

            try {
                // Attendre Firebase
                await new Promise(resolve => setTimeout(resolve, 2000));

                const user = firebase.auth().currentUser;
                if (!user) {
                    status.textContent += '‚ùå ERREUR: Utilisateur non connect√©\n';
                    return;
                }

                status.textContent += `‚úÖ Utilisateur connect√©: ${user.uid}\n\n`;

                const db = firebase.firestore();
                const userId = user.uid;

                // R√©cup√©rer les donn√©es locales
                const localSeasonData = localStorage.getItem('seasonData');
                const localSeasonStats = localStorage.getItem('seasonStats');

                if (!localSeasonData && !localSeasonStats) {
                    status.textContent += '‚ÑπÔ∏è Aucune donn√©e locale trouv√©e\n';
                    return;
                }

                status.textContent += 'üìä Donn√©es locales trouv√©es:\n';
                if (localSeasonData) status.textContent += '   ‚úÖ Donn√©es saison\n';
                if (localSeasonStats) status.textContent += '   ‚úÖ Statistiques saison\n\n';

                // Synchroniser les donn√©es saison
                if (localSeasonData) {
                    try {
                        const seasonData = JSON.parse(localSeasonData);
                        await db.collection('seasons').doc(userId).set(seasonData);
                        status.textContent += '‚úÖ Donn√©es saison synchronis√©es\n';
                    } catch (error) {
                        status.textContent += `‚ùå Erreur synchronisation saison: ${error.message}\n`;
                    }
                }

                // Synchroniser les statistiques saison
                if (localSeasonStats) {
                    try {
                        const seasonStats = JSON.parse(localSeasonStats);
                        await db.collection('profiles').doc(userId).set({
                            seasonStats: seasonStats
                        }, { merge: true });
                        status.textContent += '‚úÖ Statistiques saison synchronis√©es\n';
                    } catch (error) {
                        status.textContent += `‚ùå Erreur synchronisation stats: ${error.message}\n`;
                    }
                }

                // V√©rifier la synchronisation
                status.textContent += '\nüîç V√©rification de la synchronisation...\n';

                try {
                    const seasonDoc = await db.collection('seasons').doc(userId).get();
                    if (seasonDoc.exists) {
                        status.textContent += '‚úÖ Donn√©es saison v√©rifi√©es dans Firestore\n';
                    } else {
                        status.textContent += '‚ö†Ô∏è Donn√©es saison non trouv√©es apr√®s synchronisation\n';
                    }
                } catch (error) {
                    status.textContent += `‚ùå Erreur v√©rification saison: ${error.message}\n`;
                }

                try {
                    const profileDoc = await db.collection('profiles').doc(userId).get();
                    if (profileDoc.exists && profileDoc.data().seasonStats) {
                        status.textContent += '‚úÖ Statistiques saison v√©rifi√©es dans Firestore\n';
                    } else {
                        status.textContent += '‚ö†Ô∏è Statistiques saison non trouv√©es apr√®s synchronisation\n';
                    }
                } catch (error) {
                    status.textContent += `‚ùå Erreur v√©rification stats: ${error.message}\n`;
                }

                status.textContent += '\nüéâ SYNCHRONISATION TERMIN√âE\n';
                status.textContent += 'üí° Vous pouvez maintenant utiliser les donn√©es saison dans le cloud !\n';

            } catch (error) {
                status.textContent += `\nüí• ERREUR G√âN√âRALE: ${error.message}\n`;
            }
        }
    </script>
</body>
</html>