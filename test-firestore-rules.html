<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test R√®gles Firestore CultureLudo</title>
    <!-- Firebase SDK -->
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script defer src="firebase-config.js"></script>
</head>
<body>
    <h1>üß™ Test R√®gles Firestore CultureLudo</h1>
    <button onclick="testAllCollections()">Tester toutes les collections</button>
    <div id="results" style="margin-top: 20px; font-family: monospace; white-space: pre-line;"></div>

    <script>
        async function testAllCollections() {
            const results = document.getElementById('results');
            results.textContent = 'üîÑ Test des collections en cours...\n\n';

            try {
                // Attendre que Firebase soit pr√™t
                await new Promise(resolve => setTimeout(resolve, 2000));

                const user = firebase.auth().currentUser;
                if (!user) {
                    results.textContent += '‚ùå UTILISATEUR: Non connect√©\n';
                    return;
                }

                results.textContent += `‚úÖ UTILISATEUR: Connect√© (${user.uid})\n\n`;

                const db = firebase.firestore();
                const userId = user.uid;

                // Test des collections EXISTANTES
                results.textContent += 'üìÅ COLLECTIONS EXISTANTES:\n';

                const existingCollections = [
                    'profiles',
                    'scores',
                    'questionBank',
                    'notifications',
                    'challenges',
                    'dailyQuiz',
                    'dailyQuizScores',
                    'friendRequests',
                    'friendships',
                    'survivalRecords'
                ];

                for (const collection of existingCollections) {
                    try {
                        const snapshot = await db.collection(collection).limit(1).get();
                        results.textContent += `   ‚úÖ ${collection}: Accessible\n`;
                    } catch (error) {
                        results.textContent += `   ‚ùå ${collection}: ${error.message}\n`;
                    }
                }

                // Test des collections NOUVELLES (gamification)
                results.textContent += '\nüéÆ COLLECTIONS GAMIFICATION:\n';

                const newCollections = [
                    'seasons',
                    'cultureCards',
                    'customQuizzes',
                    'bets',
                    'clubs',
                    'tournaments',
                    'globalStats'
                ];

                for (const collection of newCollections) {
                    try {
                        const snapshot = await db.collection(collection).limit(1).get();
                        results.textContent += `   ‚úÖ ${collection}: Accessible\n`;
                    } catch (error) {
                        results.textContent += `   ‚ùå ${collection}: ${error.message}\n`;
                    }
                }

                // Test des sous-collections
                results.textContent += '\nüìÇ SOUS-COLLECTIONS:\n';

                try {
                    // Test sous-collection saisons
                    const seasonSnapshot = await db.collection('seasons').limit(1).get();
                    if (!seasonSnapshot.empty) {
                        const seasonId = seasonSnapshot.docs[0].id;
                        const entriesSnapshot = await db.collection('seasons')
                            .doc(seasonId)
                            .collection('entries')
                            .limit(1)
                            .get();
                        results.textContent += '   ‚úÖ seasons/*/entries: Accessible\n';
                    } else {
                        results.textContent += '   ‚ÑπÔ∏è seasons/*/entries: Aucune saison trouv√©e\n';
                    }
                } catch (error) {
                    results.textContent += `   ‚ùå seasons/*/entries: ${error.message}\n`;
                }

                try {
                    // Test sous-collection clubs
                    const clubSnapshot = await db.collection('clubs').limit(1).get();
                    if (!clubSnapshot.empty) {
                        const clubId = clubSnapshot.docs[0].id;
                        const feedSnapshot = await db.collection('clubs')
                            .doc(clubId)
                            .collection('feed')
                            .limit(1)
                            .get();
                        results.textContent += '   ‚úÖ clubs/*/feed: Accessible\n';
                    } else {
                        results.textContent += '   ‚ÑπÔ∏è clubs/*/feed: Aucun club trouv√©\n';
                    }
                } catch (error) {
                    results.textContent += `   ‚ùå clubs/*/feed: ${error.message}\n`;
                }

                try {
                    // Test sous-collection favoris culture
                    const favoritesSnapshot = await db.collection('profiles')
                        .doc(userId)
                        .collection('cultureCardFavorites')
                        .limit(1)
                        .get();
                    results.textContent += '   ‚úÖ profiles/*/cultureCardFavorites: Accessible\n';
                } catch (error) {
                    results.textContent += `   ‚ùå profiles/*/cultureCardFavorites: ${error.message}\n`;
                }

                // Test d'√©criture
                results.textContent += '\n‚úèÔ∏è TESTS D\'√âCRITURE:\n';

                try {
                    // Test √©criture profil
                    await db.collection('profiles').doc(userId).set({
                        testField: 'test_' + Date.now(),
                        lastTest: new Date()
                    }, { merge: true });
                    results.textContent += '   ‚úÖ √âcriture profil: OK\n';
                } catch (error) {
                    results.textContent += `   ‚ùå √âcriture profil: ${error.message}\n`;
                }

                try {
                    // Test √©criture score
                    const scoreRef = await db.collection('scores').add({
                        userId: userId,
                        score: 100,
                        total: 10,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    results.textContent += '   ‚úÖ √âcriture score: OK\n';

                    // Nettoyer
                    await scoreRef.delete();
                } catch (error) {
                    results.textContent += `   ‚ùå √âcriture score: ${error.message}\n`;
                }

                results.textContent += '\nüèÅ TESTS TERMIN√âS\n';

                // R√©sum√©
                const errorCount = (results.textContent.match(/‚ùå/g) || []).length;
                if (errorCount === 0) {
                    results.textContent += '\nüéâ TOUS LES TESTS R√âUSSIS ! R√®gles Firestore OK.';
                } else {
                    results.textContent += `\n‚ö†Ô∏è ${errorCount} erreur(s) d√©tect√©e(s). V√©rifiez les r√®gles.`;
                }

            } catch (error) {
                results.textContent += `\nüí• ERREUR G√âN√âRALE: ${error.message}\n`;
            }
        }
    </script>
</body>
</html>